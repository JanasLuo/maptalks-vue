/*!
 * @maptalks/gltf-layer v0.33.4
 * LICENSE : UNLICENSED
 * (c) 2016-2022 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("@maptalks/gl")):"function"==typeof define&&define.amd?define(["exports","maptalks","@maptalks/gl"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks=t.maptalks||{},t.maptalks,t.maptalksgl)}(this,(function(t,e,r){"use strict";function s(t){if(t&&t.t)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var s=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,s.get?s:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var n=s(e),i=s(r);const o='function(t){var e="undefined"!=typeof Float32Array?Float32Array:Array;function r(t,e,r){var n=e[0],s=e[1],i=e[2],o=e[3],c=e[4],a=e[5],u=e[6],f=e[7],h=e[8],l=e[9],d=e[10],m=e[11],g=e[12],_=e[13],b=e[14],p=e[15],y=r[0],w=r[1],A=r[2],T=r[3];return t[0]=y*n+w*c+A*h+T*g,t[1]=y*s+w*a+A*l+T*_,t[2]=y*i+w*u+A*d+T*b,t[3]=y*o+w*f+A*m+T*p,y=r[4],w=r[5],A=r[6],T=r[7],t[4]=y*n+w*c+A*h+T*g,t[5]=y*s+w*a+A*l+T*_,t[6]=y*i+w*u+A*d+T*b,t[7]=y*o+w*f+A*m+T*p,y=r[8],w=r[9],A=r[10],T=r[11],t[8]=y*n+w*c+A*h+T*g,t[9]=y*s+w*a+A*l+T*_,t[10]=y*i+w*u+A*d+T*b,t[11]=y*o+w*f+A*m+T*p,y=r[12],w=r[13],A=r[14],T=r[15],t[12]=y*n+w*c+A*h+T*g,t[13]=y*s+w*a+A*l+T*_,t[14]=y*i+w*u+A*d+T*b,t[15]=y*o+w*f+A*m+T*p,t}function n(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,r,n){var s=new e(3);return s[0]=t,s[1]=r,s[2]=n,s}function i(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function o(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t}function c(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function a(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function u(t,e,r,n,s){return t[0]=e,t[1]=r,t[2]=n,t[3]=s,t}function f(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function h(t,e,r,n){var s=e[0],i=e[1],o=e[2],c=e[3],a=r[0],u=r[1],f=r[2],h=r[3],l=void 0,d=void 0,m=void 0,g=void 0,_=void 0;return(d=s*a+i*u+o*f+c*h)<0&&(d=-d,a=-a,u=-u,f=-f,h=-h),1-d>1e-6?(l=Math.acos(d),m=Math.sin(l),g=Math.sin((1-n)*l)/m,_=Math.sin(n*l)/m):(g=1-n,_=n),t[0]=g*s+_*a,t[1]=g*i+_*u,t[2]=g*o+_*f,t[3]=g*c+_*h,t}n(),function(){var t,r=(t=new e(4),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var l,d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};n(),s(1,0,0),s(0,1,0),f(),f(),l=new e(9),e!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[5]=0,l[6]=0,l[7]=0),l[0]=1,l[4]=1,l[8]=1;\n/*!\n   * @maptalks/gltf-loader v0.25.7\n   * LICENSE : UNLICENSED\n   * (c) 2016-2022 maptalks.org\n   */\nlet m=0;function g(t){return null==t}function _(t){return!g(t)}function b(t){for(let e=1;e<arguments.length;e++){const r=arguments[e];for(const e in r)t[e]=r[e]}return t}function p(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView\'s component type: "+t)}function y(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function w(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),r=e.length,n=new Uint8Array(r);for(let t=0;t<r;t++)n[t]=e.charCodeAt(t);return n.buffer}const A=[],T=[],I=[],x=[0,0,0],v=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),M=[1,1,1];function O(t,e,r,n,s,i,o){const c=p(o);if((0===s||s===n*c.BYTES_PER_ELEMENT)&&i%c.BYTES_PER_ELEMENT==0){const s=new c(e,i,r*n);return t.set(s),t}const a=new Uint8Array(n*c.BYTES_PER_ELEMENT);for(let o=0;o<r;o++){let r=null;const u=new Uint8Array(e,s*o+i,n*c.BYTES_PER_ELEMENT);a.set(u),r=new c(a.buffer,0,n);for(let e=0;e<n;e++)t[o*n+e]=r[e]}return t}const P="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function E(t,e,r){const n=new Uint8Array(t,e,r);return P.decode(n)}const k={get:function(t,e={}){e||(e={});const r=new AbortController,n={signal:r.signal,method:e.method||"GET",referrerPolicy:"origin"};"POST"===e.method&&(g(e.body)||(n.body=JSON.stringify(e.body))),g(e.headers)||(n.headers=e.headers),g(e.credentials)||(n.credentials=e.credentials);const s=fetch(t,n).then((t=>{const r=this.t(t,e.responseType);return r.message?r:r.then((r=>"arraybuffer"===e.responseType?{data:r,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:r)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return s.xhr=r,s},t:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={})=>(e||(e={}),e.responseType="arraybuffer",k.get(t,e)),getJSON:function(t,e={}){return e&&e.jsonp?k.jsonp(t):((e=e||{}).responseType="json",k.get(t,e))},jsonp:function(t){const e="_maptalks_jsonp_"+m++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let r=document.createElement("script");return r.type="text/javascript",r.src=t,new Promise((t=>{window[e]=function(n){document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[e],t(n)},document.getElementsByTagName("head")[0].appendChild(r)}))}};class S{constructor(t,e,r){this.i=t,this.decoders=e,this.o=r,this.images={},this.u={}}requestImageFromBufferURI(t,e,r){if(this.buffers[t.id]){const n=this.buffers[t.id],s=this.h(e,n);return this.getImageByBuffer(s,r)}if(this.u[t.id])return this.u[t.id].then((()=>{const n=this.buffers[t.id],s=this.h(e,n);return this.getImageByBuffer(s,r)}));if(y(t.uri)){const n=this.buffers[t.id]=w(t.uri),s=this.h(e,n);return this.getImageByBuffer(s,r)}return this.u[t.id]=k.getArrayBuffer(t.uri,null).then((n=>{const s=this.buffers[t.id]=n.data,i=this.h(e,s);return this.getImageByBuffer(i,r)}))}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const r=this.decoders;if(r[e.mimeType])return r[e.mimeType](t,{supportedFormats:this.o});if("image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType)return console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null);{const r=new Blob([t],{type:e.mimeType}),n=URL.createObjectURL(r);return this.l(e.id,n)}}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this.u[t.id]?this.u[t.id].then((()=>this.images[t.id])):this.u[t.id]=this.l(t.id,e)}l(t,e){return new Promise(((r,n)=>{this.i(e,((s,i)=>{s?n(s):(URL.revokeObjectURL(e),this.images[t]=i,r(this.images[t]))}))}))}}const N=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16];class C{constructor(t,e,r){this.rootPath=t,this.gltf=e,this.m=!1,this.glbBuffer=r,this.buffers={},this.requests={},this.accessors={},this.g()}_(t,e){const r=this.gltf,n=r.accessors[e];if(void 0===n.bufferView)return this.accessors[n.id]=this.p(t,e,null,0),Promise.resolve(this.accessors[n.id]);if(n&&this.accessors[n.id])return Promise.resolve(this.accessors[n.id]);const s=r.bufferViews[n.bufferView];return this.A(s).then((r=>{const{buffer:s,byteOffset:i}=r;return this.accessors[n.id]=this.p(t,e,s,i)}))}A(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(y(e.uri)){const t=this.buffers[e.id]=w(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;return t=e.uri.indexOf("://")>0||e.uri.indexOf("blob:")>=0?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=k.getArrayBuffer(t,null).then((t=>({buffer:this.buffers[e.id]=t.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}p(t,e,r,n=0){const s=this.gltf,i=s.accessors[e],o=void 0!==i.bufferView?s.bufferViews[i.bufferView]:{},c=(o.byteOffset||0)+n,a=this.T(i.type),u=p(i.componentType),f=o.byteStride||0,h={array:void 0,name:t,accessorName:e,byteLength:i.count*a*u.BYTES_PER_ELEMENT,componentType:i.componentType,count:i.count,type:i.type,itemSize:a};if(i.min&&(h.min=i.min),i.max&&(h.max=i.max),r)if(this.m)h.byteStride=f,h.byteOffset=c+(i.byteOffset||0),!f||f===a*u.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(h.array=this.I(r,i.count,a,c+(i.byteOffset||0),u),h.array.buffer.byteLength===h.byteLength&&(h.byteOffset=0)):h.array=new Uint8Array(r,c,o.byteLength);else if(i.interleaved){h.byteStride=0,h.byteOffset=0;const t=new u(i.count*a);h.array=O(t,r,i.count,a,f,c+(i.byteOffset||0),i.componentType)}else h.byteStride=0,h.array=this.I(r,i.count,a,c+(i.byteOffset||0),u),h.byteOffset=h.array.byteOffset;else{h.array=new u(i.count);const t=h.min||h.max;t&&(h.array[0]=t[0],h.array[1]=t[1],h.array[2]=t[2])}return h}g(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let r=0;r<t.length;r++)e!==r&&t[e].bufferView===t[r].bufferView&&(t[e].interleaved=t[r].interleaved=!0);else for(const e in t)for(const r in t)e!==r&&t[e].bufferView===t[r].bufferView&&(t[e].interleaved=t[r].interleaved=!0)}I(t,e,r,n,s){return n%s.BYTES_PER_ELEMENT!=0&&(t=t.slice(n,n+e*r*s.BYTES_PER_ELEMENT),n=0),new s(t,n,r*e)}T(t){const e=N.indexOf(t);return N[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,r=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:r}=e;return this.A(e).then((n=>{const{buffer:s,byteOffset:i}=n,o=E(s,i+(e.byteOffset||0),r);return t.content=o,t}))}if(t.uri){if(y(t.uri)){const e=w(t.uri),r=E(e,0,e.byteLength);return t.content=r,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return k.get(e).then((e=>(t.content=e,t)))}}return Promise.resolve(t)}));return Promise.all(r).then((()=>t))}}class B extends S{constructor(t,e,r,n,s,i){super(n,s,i),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=r,this.accessor=new C(t,e,r)}iterate(t,e){const r=this.gltf[e];if(!r)return;let n=0;for(const e in r)t(e,r[e],n++)}createNode(t){const e={};if(_(t.name)&&(e.name=t.name),_(t.children)&&(e.children=t.children),_(t.jointName)&&(e.jointName=t.jointName),_(t.matrix)&&(e.matrix=t.matrix),_(t.rotation)&&(e.rotation=t.rotation),_(t.scale)&&(e.scale=t.scale),_(t.translation)&&(e.translation=t.translation),_(t.extras)&&(e.extras=t.extras),_(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const n=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(A,e.translation||x),s=function(t,e){var r=e[0],n=e[1],s=e[2],i=e[3],o=r+r,c=n+n,a=s+s,u=r*o,f=n*o,h=n*c,l=s*o,d=s*c,m=s*a,g=i*o,_=i*c,b=i*a;return t[0]=1-h-m,t[1]=f+b,t[2]=l-_,t[3]=0,t[4]=f-b,t[5]=1-u-m,t[6]=d+g,t[7]=0,t[8]=l+_,t[9]=d-g,t[10]=1-u-h,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(T,e.rotation||v),i=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(I,e.scale||M);return r(i,s,i),r(t,n,i)}return function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}v(t){const e={};for(const r in t){const n=t[r];let s,i;n.instanceTechnique&&n.instanceTechnique.values?(s=n.instanceTechnique,i=s.values.diffuse):(s=n,i=s.values.tex||s.values.diffuseTex||s.values.diffuse);const o={baseColorTexture:{index:i}};n.name&&(o.name=n.name),n.extensions&&(o.extensions=n.extensions),n.extras&&(o.extras=n.extras),e[r]=o}return e}M(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const r=this.gltf.bufferViews[e.bufferView],n=(r.byteOffset||0)+this.glbBuffer.byteOffset,s=r.byteLength,i=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,n,s);return this.getImageByBuffer(i,t)}return this.requestExternalImage(t)}O(t){const e=this.gltf.textures[t];if(!e)return null;const r=this.gltf.images[e.source];return this.M(r).then((t=>{const n=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extras:r.extras},sampler:n}}))}getBaseColorTexture(t){const e=this.gltf.materials[t];let r,n;if(e.instanceTechnique&&e.instanceTechnique.values?(r=e.instanceTechnique,n=r.values.diffuse):(r=e,n=r.values.tex||r.values.diffuseTex||r.values.diffuse),void 0===n||void 0===this.gltf.textures)return null;const s=this.gltf.textures[n];if(!s)return null;const i=this.gltf.samplers[s.sampler];return{format:s.format||6408,internalFormat:s.internalFormat||6408,type:s.type||5121,sampler:i,source:this.gltf.images[s.source]}}getMaterial(){return null}getAnimations(){return null}}class R extends S{constructor(t,e,r,n,s,i){super(n,s,i),this.rootPath=t,this.gltf=e,this.glbBuffer=r,this.buffers={},this.requests={},this.accessor=new C(t,e,r)}iterate(t,e){const r=this.gltf[e];if(r)for(let e=0;e<r.length;e++)t(e,r[e],e)}createNode(t){const e={};return b(e,t),!_(t.weights)&&this.gltf.meshes&&_(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}O(t){const e=this.gltf.textures[t];if(!e)return null;const r=this.gltf.images[e.source];return this.M(r).then((t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extensions:r.extensions,extras:r.extras}};b(n,e);const s=_(e.sampler)?this.gltf.samplers[e.sampler]:void 0;return s&&(n.sampler=s),t.format&&(n.format=t.format),n}))}M(t){if(!_(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],r=this.gltf.buffers[e.buffer];if(r.uri)return this.requestImageFromBufferURI(r,e,t);if(this.glbBuffer)return this.P(e,t)}return null}P(t,e){const r=this.h(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(r,e)}h(t,e,r){r=r||0;const n=t.byteOffset+r,s=t.byteLength;return new Uint8Array(e,n,s)}k(t,e){const r=new Array(t.byteLength);for(let e=0;e<t.byteLength;e++)r[e]=String.fromCharCode(t[e]);return r.join(""),"data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(r)))}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let r=0;r<e.length;r++)t[r].samplers=e[r];return t}))}getSamplers(t){const e=[];for(let r=0;r<t.length;r++)(_(t[r].input)||_(t[r].output))&&(e.push(this.accessor._("input",t[r].input)),e.push(this.accessor._("output",t[r].output)));return Promise.all(e).then((e=>{for(let r=0;r<e.length/2;r++)t[r].input=e[2*r],t[r].output=e[2*r+1],t[r].interpolation||(t[r].interpolation="LINEAR");return t}))}}const U="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class L{static read(t,e=0,r=0){r||(r=t.byteLength);const n=new DataView(t,e,r),s=n.getUint32(4,!0);if(1===s)return L.readV1(n,e);if(2===s)return L.readV2(t,e);throw new Error("Unsupported glb version : "+s)}static readV1(t,e){const r=t.getUint32(8,!0),n=t.getUint32(12,!0);if(r!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb\'s byte length.");const s=D(t.buffer,20+e,n);return{json:JSON.parse(s),glbBuffer:{byteOffset:20+e+n,buffer:t.buffer,byteLength:r}}}static readV2(t,e){let r,n,s;const i=new DataView(t,e+12);let o=0;for(;o<i.byteLength;){const c=i.getUint32(o,!0);o+=4;const a=i.getUint32(o,!0);if(o+=4,1313821514===a)r=D(t,e+12+o,c);else if(5130562===a){s=e+12+o,n=c;break}o+=c}return{json:JSON.parse(r),glbBuffer:{byteOffset:s,buffer:t,byteLength:n}}}}function D(t,e,r){if(U){const n=new Uint8Array(t,e,r);return U.decode(n)}return function(t){const e=t.length;let r="";for(let n=0;n<e;){let s=t[n++];if(128&s){let r=j[s>>3&7];if(!(64&s)||!r||n+r>e)return null;for(s&=63>>r;r>0;r-=1){const e=t[n++];if(128!=(192&e))return null;s=s<<6|63&e}}r+=String.fromCharCode(s)}return r}(new Uint8Array(t,e,r))}const j=[1,1,1,1,2,2,3,0],q=[0,0,0],F=[0,0,0,1],V=[1,1,1],H={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},K={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},$={S(t,e,r,n,s,o,c,a){const u=_(t)?e.animations:[e.animations[0]],f={};for(let e=0;e<u.length;e++){const h=u[e],l=h.name||e;if(_(t)&&l!==t)continue;const m=h.channelsMap[r];if(m)for(let t=0;t<m.length;t++){const e=m[t];"translation"===e.target.path?(this.N(s,h.samplers[e.sampler],n,1),f.translation=i(q,s)):"rotation"===e.target.path?(this.C(o,h.samplers[e.sampler],n,1),f.rotation=d(F,o)):"scale"===e.target.path?(this.N(c,h.samplers[e.sampler],n,1),f.scale=i(V,c)):"weights"===e.target.path&&a&&(this.N(a,h.samplers[e.sampler],n,a.length),f.weights=a)}}return f},N(t,e,r,n){switch(e.interpolation){case"LINEAR":{const s=this.B(K,e,r,1*n);s&&(t=function(t,e,r,n){for(let s=0;s<t.length;s++)t[s]=e[s]+n*(r[s]-e[s]);return t}(t,s.PREVIOUS,s.NEXT,s.INTERPOLATION));break}case"STEP":{const s=this.B(K,e,r,1*n);s&&(t=function(t,e){for(let r=0;r<t.length;r++)t[r]=e[r];return t}(t,...s.PREVIOUS));break}case"CUBICSPLINE":{const s=this.B(K,e,r,3*n);s&&(t=this.R(t,s,e.input.array,3*n));break}}return t},C(t,e,r){switch(e.interpolation){case"LINEAR":{const n=this.B(K,e,r,1);n&&h(t,n.PREVIOUS,n.NEXT,n.INTERPOLATION);break}case"STEP":{const n=this.B(K,e,r,1);n&&(t=u(t,...n.PREVIOUS));break}case"CUBICSPLINE":{const n=this.B(K,e,r,3);if(n){for(let t=0;t<n.PREVIOUS.length;t++)n.PREVIOUS[t]=Math.acos(n.PREVIOUS[t]),n.NEXT[t]=Math.acos(n.NEXT[t]);t=this.R(t,n,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},U(t,e){const r=t.length;let n,s,i,o=0,c=r-1,a=Math.floor((o+c)/2);for(;o<=r-1&&c>=0;){if(o===c)return null;if(t[a]<=e&&e<=t[a+1]){const r=t[a];return n=a,s=a+1,i=(e-r)/(t[a+1]-r),{preIndx:n,nextIndex:s,interpolation:i}}e<t[a]?(c=a,a=Math.floor((o+c)/2)):t[a+1]<e&&(o=a,a=Math.floor((o+c)/2))}return null},B(t,e,r,n){const s=e.input.array,i=e.output.array,o=e.output.itemSize;(r<s[0]||r>s[s.length-1])&&(r=Math.max(s[0],Math.min(s[s.length-1],r))),r===s[s.length-1]&&(r=s[0]);const c=this.U(s,r);if(!c||!c.nextIndex)return null;const{preIndx:a,nextIndex:u,interpolation:f}=c;t.PREINDEX=a,t.NEXTINDEX=u,t.INTERPOLATION=f;const h=o*n;return t.PREVIOUS=i.subarray(t.PREINDEX*h,(t.PREINDEX+1)*h),t.NEXT=i.subarray(t.NEXTINDEX*h,(t.NEXTINDEX+1)*h),t},R(t,e,r,n){const s=e.INTERPOLATION,i=r[e.PREINDEX],o=r[e.NEXTINDEX];for(let r=0;r<3;r++){const c=e.PREVIOUS[n+r],a=(o-i)*e.PREVIOUS[2*n+r],u=e.NEXT[3+r],f=(o-i)*e.NEXT[r],h=(2*Math.pow(s,3)-3*Math.pow(s,2)+1)*c+(Math.pow(s,3)-2*Math.pow(s,2)+s)*a+(2*-Math.pow(s,3)+3*Math.pow(s,2))*u+(Math.pow(s,3)-Math.pow(s,2))*f;t[r]=h}return t},getAnimationClip(t,e,r,n){const s=t.nodes[e]&&t.nodes[e].weights;return o(q,...H.TRANSLATION),u(F,...H.ROTATION),o(V,...H.SCALE),this.S(n,t,e,r,q,F,V,s)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,r)=>{let n=-1/0,s=1/0;const i=e.channels;for(let t=0;t<i.length;t++){const r=i[t],o=e.samplers[r.sampler].input.array;o[o.length-1]>n&&(n=o[o.length-1]),o[0]<s&&(s=o[0])}const o=e.name||r;t.timeSpan[o]={max:n,min:s}})),t.timeSpan},getTimeSpanByName(t,e){const r=this.getTimeSpan(t);return r?_(e)?r[e]:r[Object.keys(r)[0]]:null}};let G=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(nt){}t&&"undefined"!=typeof createImageBitmap&&(G=!0)}const J="undefined"==typeof document?null:document.createElement("canvas");class X{constructor(t,e,r){if(this.options=r||{},this.options.decoders||(this.options.decoders={}),e.buffer instanceof ArrayBuffer){const{json:r,glbBuffer:n}=L.read(e.buffer,e.byteOffset,e.byteLength);this.L(t,r,n)}else this.L(t,e);this.D=new C(this.rootPath,this.gltf,this.glbBuffer),this.j()}j(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders.ktx2)throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded")}}q(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this.D.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}load(t){t=t||{};const e=this.F(t),r=this.V(),n=this.H(),s=this.q();return Promise.all([e,r,n,s]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let t=0;t<e.length;t++){const r=e[t];r.channelsMap={};for(let t=0;t<r.channels.length;t++){const e=r.channels[t];r.channelsMap[e.target.node]||(r.channelsMap[e.target.node]=[]),r.channelsMap[e.target.node].push(e)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:r}=this.gltf;for(let r=0;r<e.length;r++)e[r].uri&&e[r].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[r].uri});for(let e=0;e<r.length;e++)r[e].uri&&r[e].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:r[e].uri})}return t}static getAnimationClip(t,e,r,n){return $.getAnimationClip(t,e,r,n)}static getAnimationTimeSpan(t,e){return $.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return p(t)}static readInterleavedArray(t,e,r,n,s,i,o){return O(t,e,r,n,s,i,o)}L(t,e,r){this.gltf=e,this.glbBuffer=r,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=G?Y:this.options.requestImage||z,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new R(t,e,r,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{}),this.adapter.iterate(((t,e,r)=>{e.id="buffer_"+r}),"buffers"),this.adapter.iterate(((t,e,r)=>{e.id="image_"+r}),"images"),this.adapter.iterate(((t,e,r)=>{e.id="accessor_"+r}),"accessors")):(this.adapter=new B(t,e,r,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{}),this.adapter.iterate(((t,e,r)=>{e.id="accessor_"+r}),"accessors"),this.adapter.iterate(((t,e,r)=>{e.id="image_"+r}),"images"))}K(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(r=t.children[0])&&isFinite(r)||function(t){return!g(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}(t.children[0])))return t;const n=t.children.map((t=>{const r=e[t];return r.nodeIndex=t,this.K(r,e)}));t.children=n}var r;return t}F(t){return this.$(t).then((t=>{const e=this.scenes=[];let r;for(const e in t)t[e]=this.K(t[e],t),t[e].nodeIndex=Number(e)?Number(e):e;this.adapter.iterate(((n,s,i)=>{const o={};s.name&&(o.name=s.name),s.nodes&&(o.nodes=s.nodes.map((e=>t[e]))),this.gltf.scene===n&&(r=i),e.push(o)}),"scenes");const n={asset:this.gltf.asset,scene:r,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins};if(this.gltf.extensions&&(n.extensions=this.gltf.extensions),1===this.version){const t=this.adapter.v(this.gltf.materials);n.materials=t}return n}))}$(t){return this.G(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,r)=>{const n=this.adapter.createNode(r,this.meshes,this.skins);t[e]=n}),"nodes"),t}))}J(){this.skins=[];const t=[];return this.adapter.iterate(((e,r,n)=>{t.push(this.X(r).then((t=>{t.index=n,this.skins.push(t)})))}),"skins"),t}X(t){const e=t.inverseBindMatrices;return this.adapter.accessor._("inverseBindMatrices",e).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}V(){const t=this.gltf.animations;return _(t)?this.adapter.getAnimations(t):null}G(t){this.meshes={};let e=[];return this.adapter.iterate(((r,n,s)=>{e.push(this.W(n,t).then((t=>{t.index=s,this.meshes[r]=t})))}),"meshes"),e=e.concat(this.J()),Promise.all(e)}W(t,e){const r=t.primitives.map((t=>this.Y(t,e))).filter((t=>!!t));return Promise.all(r).then((e=>{const r={};return b(r,t),r.primitives=e,r}))}H(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const r in t)e.push(this.adapter.O(r));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++)if(e[t]&&e[t].image.array){const r=e[t].image.array.buffer;r&&this.transferables.indexOf(r)<0&&this.transferables.push(r)}if(!Array.isArray(t)){const r={},n=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(r[n[t]]=e[t]);return r}return e}))}Y(t,e){let r;const n=[],s=t.extensions;if(_(t.targets))for(let e=0;e<t.targets.length;e++){const r=t.targets[e];for(const t in r){const s=this.adapter.accessor._(`morphTargets_${t}_${e}`,r[t]);s&&n.push(s)}}if(s&&s.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:i,attributes:o}=s.KHR_draco_mesh_compression,c=this.gltf.bufferViews[i],a=this.D.A(c).then((r=>{const{buffer:n,byteOffset:s}=r;let{byteOffset:i,byteLength:a}=c;i||(i=0);const u=new DataView(n,s+i,a),f={attributes:o,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(u,f).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}));n.push(a),r=Promise.all(n)}else{const e=t.attributes;for(const t in e){const r=this.adapter.accessor._(t,e[t]);r&&n.push(r)}if(_(t.indices)){const e=this.adapter.accessor._("indices",t.indices);e&&n.push(e)}r=Promise.all(n)}return r.then((e=>{if(s&&s.KHR_draco_mesh_compression){const r=t.targets?t.targets.length:0;e[r]=e[r].concat(e.slice(0,r)),e=e[r]}let r,n;const i={attributes:e.reduce(((t,e)=>{if("indices"===e.name)r=e;else if(e.name.indexOf("morphTargets_")>-1)n=n||{},n[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],r=[-1/0,-1/0,-1/0],{itemSize:n,array:s}=e,i=s.length/n;for(let e=0;e<i;e++)for(let i=0;i<n;i++){const o=e*n+i;s[o]<t[i]&&(t[i]=s[o]),s[o]>r[i]&&(r[i]=s[o])}if(e.quantization){const n=e.quantization,s=n.range/(1<<n.quantizationBits),i=n.minValues;a(t,t,s),c(t,t,i),a(r,r,s),c(r,r,i)}e.min=t,e.max=r}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t}),{}),material:t.material};return r&&(i.indices=r),n&&(i.morphTargets=n),i.mode=_(t.mode)?t.mode:4,_(t.extras)&&(i.extras=t.extras),i}))}}function z(t,e){const r=new Image;r.crossOrigin="",r.onload=()=>{if(!J)return void e(new Error("There is no canvas to draw image!"));J.width=r.width,J.height=r.height;const t=J.getContext("2d");t.drawImage(r,0,0,r.width,r.height);const n=t.getImageData(0,0,r.width,r.height),s={width:r.width,height:r.height,data:new Uint8Array(n.data)};e(null,s)},r.onerror=function(t){e(t)},r.src=t}let W,Q;function Y(t,e){W||(W=new OffscreenCanvas(2,2),Q=W.getContext("2d")),fetch(t).then((t=>t.blob())).then((t=>createImageBitmap(t))).then((t=>{let{width:r,height:n}=t;Z(r)||(r=tt(r)),Z(n)||(n=tt(n)),W.width=r,W.height=n,Q.drawImage(t,0,0,r,n),t.close();const s=Q.getImageData(0,0,r,n);e(null,{width:r,height:n,data:new Uint8Array(s.data)})})).catch((t=>{console.warn(t),e(t)}))}function Z(t){return 0==(t&t-1)&&0!==t}function tt(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}\n/*!\n   * @maptalks/gl v0.67.0\n   * LICENSE : UNLICENSED\n   * (c) 2016-2022 maptalks.com\n   */const et=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},rt=et(),nt=rt.gl_trans__coders=rt.gl_trans__coders||{};nt.inject=function(t){const e=t.toString(),r=e.indexOf("{")+1,n=e.substring(0,r),s=rt.gl_trans__coders=rt.gl_trans__coders||{};let i=`${n}\\n    const _____getGlobal = ${et.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals[\'gl_trans__coders\'] = g___lobals[\'gl_trans__coders\'] || {};`;for(const t in s)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(i+=\'tran_____scoders["\'+t+\'"] =\'+s[t].toString()+"\\n;");return i+="\\n"+e.substring(n.length),i},nt.registerTranscoder=function(t,e){nt[t]=e},nt.getTranscoder=function(t){return nt[t]};const st={"image/crn":nt.crn&&nt.crn(),"image/ktx2":nt.ktx2&&nt.ktx2(),"image/cttf":nt.ktx2&&nt.ktx2(),"draco":nt.draco&&nt.draco()};let it;const ot={};function ct(t,e,r){return new X(t,e,r).load({skipAttributeTransform:!0})}function at(t,e){const r=e.lastIndexOf("/"),n=e.slice(0,r),s=e.slice(e.lastIndexOf(".")).toLowerCase(),i=ut.bind(this,t);return".gltf"===s?function(t,e){return k.getJSON(t,e)}(e,{}).then((t=>t.message?t:ct(n,t,{requestImage:i,decoders:st,transferable:!0}))):".glb"===s?function(t,e){return k.getArrayBuffer(t,e)}(e,{}).then((t=>t.message?t:ct(n,{buffer:t.data,byteOffset:0},{requestImage:i,decoders:st,transferable:!0}))):null}function ut(t,e,r){ot[e]?ot[e].push(r):(ot[e]=[r],self.postMessage({type:"<request>",command:"sendImageData",actorId:t,workerId:it,params:e}))}t.onmessage=function(t){const e=t.data,r=e.url;if("addLayer"===e.command||"removeLayer"===e.command)it=t.workerId,self.postMessage({type:"<response>",actorId:e.actorId,workerId:it,params:"ok"});else if(r)!function(t){const e=t.data,r=t.callback;at(t.actorId,e.url).then((t=>{t.message?self.postMessage({callback:r,error:t}):self.postMessage({callback:r,data:t},t.transferables)})).catch((t=>{self.postMessage({callback:r,error:t})})),ot.receive=r}(t);else if(e.imageUrl){const t=ot[e.imageUrl];if(delete ot[e.imageUrl],t)for(let r=0;r<t.length;r++)t[r](null,e.result)}},Object.defineProperty(t,"Z",{value:!0})}';function a(t){return null==t}function h(t){return!a(t)}function u(t,e){const r=new Set(e);return Array.from(new Set(t.filter((t=>r.has(t)))))}function c(t,r,s=0){if(!(t&&r instanceof e.Coordinate))return null;const n=t.coordinateToPointAtRes(r,t.getGLRes());return[n.x,n.y,s]}for(
/*!
   * Contains code from THREE.js
   * MIT License
   * https://github.com/mrdoob/three.js
   */
var l=[],f=0;f<6;f++)l[f]=[];var d=[];function m(t,e,r){var s,n,i,o,a,h,u,c,f,m,p,b,_,x,v,w,T;n=(s=t)[0],i=s[1],o=s[2],a=s[3],h=s[4],u=s[5],c=s[6],f=s[7],m=s[8],p=s[9],b=s[10],_=s[11],x=s[12],v=s[13],w=s[14],T=s[15],g(l[0],a-n,f-h,_-m,T-x),g(l[1],a+n,f+h,_+m,T+x),g(l[2],a+i,f+u,_+p,T+v),g(l[3],a-i,f-u,_-p,T-v),g(l[4],a-o,f-c,_-b,T-w),g(l[5],a+o,f+c,_+b,T+w);for(var O=0;O<6;O++)if(!r||"0"!==r.charAt(O)){var S=l[O];if(d[0]=S[0]>0?e[1][0]:e[0][0],d[1]=S[1]>0?e[1][1]:e[0][1],d[2]=S[2]>0?e[1][2]:e[0][2],y(S,d)<0)return!1}return!0}var p=1/6;function g(t,e,r,s,n){return t[0]=e*p,t[1]=r*p,t[2]=s*p,t[3]=n*p,t}function y(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}const b={};const _=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],x=[0,1,0,0,1,0,0,1,0,0,1,0],v=[3,1,0,0,2,3],w=[0,0,1,0,0,1,1,1],T=[-.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0],O=[-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012],S=[.375,1,.625,.75,.375,.75,.375,.75,.625,.5,.375,.5,.375,.5,.625,.25,.375,.25,.375,.25,.625,0,.375,0,.375,.25,.375,0,.375,.25,.375,.5,.375,.25,.375,.5,.375,1,.375,.75,.375,1,.375,.75,.375,.5,.375,.75],M=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],A={"cube":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]},"plane":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(_)},NORMAL:{array:new Int8Array(x)},TEXCOORD_0:{array:new Int8Array(w)}},indices:new Uint16Array(v),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]},"pyramid":{meshes:[{primitives:[{attributes:{POSITION:{array:new Float32Array(T)},NORMAL:{array:new Float32Array(O)},TEXCOORD_0:{array:new Float32Array(S)}},indices:new Uint16Array(M),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]}};const I="undefined"==typeof document?null:document.createElement("canvas");class E extends n.worker.Actor{constructor(t,e){super(t),this.mapId=e}loadGLTF(t,e){this.i||(this.i=new r.reshader.GLTFManager(this.regl));const s=function(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}(t),n={url:s};this.send(n,null,((t,r)=>{t?e(t):e(t,r)}))}sendImageData(t,e){!function(t,e){const r=new Image;r.onload=()=>{if(!I)return void e(new Error("There is no canvas to draw image!"));I.width=r.width,I.height=r.height;const t=I.getContext("2d");t.drawImage(r,0,0,r.width,r.height);const s=t.getImageData(0,0,r.width,r.height),n={width:r.width,height:r.height,data:new Uint8Array(s.data)};e(null,n,[n.data.buffer])},r.onerror=function(t){e(t)},r.src=t}(t,((r,s)=>{r||this.isActive()&&e(null,{result:s,imageUrl:t})}))}addLayer(t,e,r){const s={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}};this.broadcast(s,null,r)}removeLayer(t,e,r){const s={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(s,null,r)}}let P=0;const N=[],k=[],C={"lightAmbient":[1,1,1],"lightDiffuse":[1,1,1],"lightSpecular":[1,1,1],"lightDirection":[1,1,1]},L=[186/255,186/255,186/255,1],R=[.2107,-.0202],B=[],F=[],U=[],D=[],V=[1,1,1],j=function(t,e){const r=[];return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=0,r[4]=t[3],r[5]=t[4],r[6]=t[5],r[7]=0,r[8]=t[6],r[9]=t[7],r[10]=t[8],r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}(function(t){const e=Math.cos(t),r=Math.sin(t),s=[];return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=e,s[5]=r,s[6]=0,s[7]=-r,s[8]=e,s}(.5*Math.PI),[0,0,0]),q={"points":0,"lines":1,"line strip":2,"line loop":3},G=[];class J extends n.renderer.OverlayLayerCanvasRenderer{constructor(t){super(t),this.gltfScenes={},this.o={}}onAdd(){super.onAdd(),this.prepareWorker()}draw(t,e){P=t,this.prepareCanvas(),this.h(e,t)}drawOnInteracting(t,e,r){P=e,this.h(r,e)}needToRedraw(){const t=this.layer.u();for(const e in t){if(t[e].isDirty()&&this.l&&this.l.length)return!0}return super.needToRedraw()}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),super.onRemove()}hitDetect(){return!1}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.m(this.canvas,t),this.regl=r.createREGL({gl:this.gl,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_s3tc"]})}t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.i=this.regl.gltfManager=this.regl.gltfManager||new r.reshader.GLTFManager(this.regl),this.p(),this.g(),this._&&this._.forEach((t=>{t.generateInstancedBuffers(this.regl)})),this.v&&this.v.forEach((t=>{t.generateBuffers(this.regl)})),this.layer.fire("contextcreate",{regl:this.regl})}g(){const t=this.layer.getMap(),e=new r.reshader.Renderer(this.regl);this.renderer=e,this.T={"projMatrix":t.projMatrix,"projViewMatrix":t.projViewMatrix,"viewMatrix":t.viewMatrix,"cameraPosition":t.cameraPosition,"altitudeScale":1},r.reshader.pbr.PBRUtils.loginIBLResOnCanvas(this.canvas,this.regl,t),this.O=new r.reshader.FBORayPicking(e,{vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform float pointSize;\n\n#include <fbo_picking_vert>\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projViewMatrix * modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    gl_PointSize = pointSize;\n\n    fbo_picking_setData(gl_Position.w, true);\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r.mat4.multiply([],e.projViewMatrix,e.modelMatrix)}}]},this.pickingFBO)}prepareWorker(){const t=this.layer.getMap();this.workerConn||(this.workerConn=new E("@maptalks/gltf-layer",t.id));const e=this.workerConn;if(!e.isActive())return;const r=this.layer.options||{},s=this.layer.getId();e.addLayer(s,r,(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}S(t){const e=b;for(const r in e){if(this.o[r])continue;const s=e[r];this.M(t,s.name,s.type,s.config)}}A(t){const e=t.getShader(),r=t.getUrl();if(!this.i)return;if(A[r]){const r=this.gltfScenes[t.I()];if(!r)return;const s=r.modelMeshes;return"wireframe"===e&&s.forEach((t=>{this.P(t.properties.geometryResource)})),void this.N(t,s)}const s=this.i.getGLTF(r),n=this.gltfScenes[t.I()];if(!s||!n)return;const i=n.modelMeshes;"wireframe"===e&&s.resources.forEach((t=>{this.P(t)})),this.N(t,i)}N(t,e){const r=t.getShader();e.forEach((e=>{const s=this.k(t,e.properties.geometryResource);e.geometry="wireframe"===r?e.properties.geometryResource.copyGeometry:e.properties.geometryResource.geometry,e.material=s}))}P(t){t.copyGeometry.data.aBarycentric||(t.copyGeometry.buildUniqueVertex(),t.copyGeometry.createBarycentric("aBarycentric"),this.regl?t.copyGeometry.generateBuffers(this.regl):(this.v=this.v||[],this.v.push(t.copyGeometry)))}M(t,e,s,i){this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},i.extraCommandProps||(i.extraCommandProps={});const o={};t&&this.C(o,N,t);const a=n.Util.extend({},i);a.extraCommandProps=n.Util.extend({},i.extraCommandProps),a.extraCommandProps.viewport=this.viewport,a.uniforms=n.Util.extend([],i.uniforms,N),a.defines=n.Util.extend({},a.defines,o),s.indexOf(".")>-1?(s=s.split("."),this.o[e]={shader:new r.reshader[s[0]][s[1]](a),type:s}):this.o[e]={shader:new r.reshader[s](a),type:s}}remove(){this.L();const t=this.o;for(const e in t)t[e].shader.dispose();this.l&&this.l.forEach((t=>{t.mesh.dispose()})),this.R&&this.R.clear(),this.B&&this.B.clear(),this.F&&this.F.clear(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}resizeCanvas(t){super.resizeCanvas(t),this.pickingFBO&&this.pickingFBO.resize(this.canvas.width,this.canvas.height),this.layer.fire("resizecanvas",{size:t})}h(t,e){let s=0;if(this.U(t),e!==this.D&&(this.V=!0,this.l=this.l||[],this.l.splice(0,this.l.length),this.j=!1,this.S(t)),function(t){let e;for(e in t)return!1;return!0}(this.gltfScenes))return;const i=this.layer.getGeometries().filter((t=>(t.isDirty()&&(this.V=!0),this.layer.isVisible()&&t.isVisible()&&t.q())));if(i.length&&(this.j||this.D===e||(this.G(i),this.j=!0),e!==this.D&&(this.l=this.J(i)),this.l.length)){for(const e in this.o){if(!i.filter((t=>t.getShader()===e)).length)continue;const o=this.X(t&&t.renderMode,e);let a=this.o[e].shader;o.triangle.sortMeshes(this.T.cameraPosition),this.T.outSize=[this.canvas.width,this.canvas.height];let h=null,u={};if(t){if(t.includes){const{newShader:r,uniforms:s}=this.H(t,a,this.o[e].type);this.o[e].shader=a=r,n.Util.extend(u,s)}this.T.halton=t.jitter||[0,0],h=t.renderTarget&&t.renderTarget.fbo,u=this.K(t,a,u)}else this.T.halton=R;this.$=t,n.Util.extend(u,this.T),a="pbr"!==e||r.reshader.pbr.PBRUtils.isSupported(this.regl)?t&&t.onlyUpdateDepthInTaa?this.o.depth.shader:this.o[e].shader:t&&t.onlyUpdateDepthInTaa?this.o.depth.shader:this.o.phong.shader,a.filter=t&&t.sceneFilter||null,this.renderer.render(a,u,o.triangle,h);if(o.pointLine.getMeshes().length){u.pointSize=this.layer.options.pointSize||1;const e=this.o.pointline.shader;e.filter=t&&t.sceneFilter||null,this.renderer.render(e,u,o.pointLine,h)}s++}this.W=!0,(!t||t&&t.isFinalRender)&&(this.completeRender(),this.layer.fire("rendercomplete-debug",{count:s})),this.D=e}}X(t,e){const s=[],n=[];for(let r=0;r<this.l.length;r++)if(this.l[r].shader===e){const e=this.l[r].mesh;this.Y(t,e,s,n)}return this.B=this.B||new r.reshader.Scene,this.R=this.R||new r.reshader.Scene,{pointLine:this.B.setMeshes(s),triangle:this.R.setMeshes(n)}}getFrameTimestamp(){return this.D}getFrameContext(){return this.$}supportRenderMode(){return!0}needRetireFrames(){return this.V}C(t,e,r){const s=r&&r.includes;if(s)for(const i in s)s[i]&&(r[i].uniformDeclares&&(e.length=0,e.push(...r[i].uniformDeclares)),r[i].defines&&n.Util.extend(t,r[i].defines))}Z(t,e){const r=e&&e.includes;if(r)for(const s in r)r[s]&&e[s].renderUniforms&&n.Util.extend(t,e[s].renderUniforms)}H(t,e,s){const i={},o={};this.C(i,N,t),this.Z(o,t);const a={vert:e.vert,frag:e.frag,uniforms:e.uniforms,extraCommandProps:e.extraCommandProps};a.defines=i,a.uniforms=n.Util.extend([],a.uniforms,N);let h=null;return t.states.includesChanged?(h=Array.isArray(s)?new r.reshader[s[0]][s[1]](a):new r.reshader[s](a),e.dispose()):h=e,{uniforms:o,newShader:h}}K(t,e,r){if(t.viewshed){for(const e in t.viewshed.renderUniforms)r[e]=t.viewshed.renderUniforms[e];n.Util.extend(e.shaderDefines,t.viewshed.defines)}if(t.floodAnalysis){for(const e in t.floodAnalysis.renderUniforms)r[e]=t.floodAnalysis.renderUniforms[e];n.Util.extend(e.shaderDefines,t.floodAnalysis.defines)}return r}getShadowMeshes(){let t=[];if(!this.layer||!this.layer.isVisible())return t;const e=this.layer.getGeometries();for(let r=0;r<e.length;r++)if(e[r].isCastShadow()&&e[r].isVisible()&&e[r].q()){const s=e[r].I();this.gltfScenes[s]&&(t=t.concat(this.gltfScenes[s].modelMeshes))}return t}tt(){return this.l?this.l.map((t=>t.mesh)):G}getAnalysisMeshes(){return this.tt()}drawOutline(t){this.extentShader||(this.extentShader=new r.reshader.MeshShader({vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projViewMatrix * modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n}\n\n",frag:"precision highp float;\n\nvoid main() {\n\n    gl_FragColor = vec4(1.0);\n\n}\n\n",positionAttribute:"POSITION",extraCommandProps:{viewport:this.viewport,cull:{enable:!1}}}));const e=this.getOutlineMeshes();e.length&&(this.F=this.F||new r.reshader.Scene,this.F.setMeshes(e),this.renderer.render(this.extentShader,{"projViewMatrix":this.T.projViewMatrix},this.F,t))}getOutlineMeshes(){let t=[];if(!this.layer)return t;const e=this.layer.getGeometries();for(let r=0;r<e.length;r++)if(e[r].isOutline()&&e[r].isVisible()&&e[r].q()){const s=e[r].I();this.gltfScenes[s]&&(t=t.concat(this.gltfScenes[s].modelMeshes))}return t}G(t){t.forEach((t=>{const e=t.I();this.gltfScenes[e]&&(t.isLoaded()&&(t.et=t.getUrl()),this.rt(e),t.isAnimated()||t.hasFunctionDefinition()||t.isOutline()||t.isDashAnimated()?t.setDirty(!0):t.setDirty(!1),t.st()&&t.nt())}))}it(t,e){return!("wireframe"===e&&!t.geometry.data.aBarycentric)}J(t){const e=this.l||[],s=this.layer.getMap();for(let n=0;n<t.length;n++){const i=t[n],o=i.getShader(),a=this.gltfScenes[i.I()];if(!a)continue;const h=a.modelMeshes;for(let t=0;t<h.length;t++){const n=h[t];this.it(n,o)&&(this.ot(n,i),this.at(n,i),this.ht(n,i),n.setUniform("uPickingId",i.I()),n.properties.isAnimated=i.isAnimated(),(n instanceof r.reshader.InstancedMesh||m(s.projViewMatrix,n.getBoundingBox()))&&e.push({shader:o,mesh:n}))}i.ut()}return e}Y(t,e,r,s){const n=e.properties.isAnimated;"fxaaAfterTaa"===t&&n?this.ct(e,r,s):"taa"!==t||n?"default"===t||"fxaa"===t?this.ct(e,r,s):t||this.ct(e,r,s):this.ct(e,r,s)}lt(t,e,s){const n=t;n.copy(),"wireframe"===s&&n.createCopyBarycentric();const i=this.ft(e,n,s),o=i.getDefines();return i instanceof r.reshader.InstancedMesh?(o.HAS_PICKING_ID=1,o.HAS_INSTANCE_COLOR=1):o.HAS_PICKING_ID=2,i.geometry.data.COLOR_0&&(o.HAS_COLOR0=1),n.extraInfo&&"MASK"===n.extraInfo.alphaMode&&(o.HAS_ALPHAMODE=1),i.setDefines(o),i}ft(t,e,s){const n=this.layer.u()[t],i=n.getGLTFMarkerType();let o=null;const a=e.material?e.material:this.k(n,e);e.material=a;const h="wireframe"===s?e.copyGeometry:e.geometry;if(this.regl?h.generateBuffers(this.regl):(this.v=this.v||[],this.v.push(h)),"multigltfmarker"===i){n.dt();const t=n.gt(r.mat4.identity(D)),e=n.getCount();o=new r.reshader.InstancedMesh(t,e,h,a),this.regl?o.generateInstancedBuffers(this.regl):(this._=this._||[],this._.push(o))}else o=new r.reshader.Mesh(h,a);o.nodeMatrix=r.mat4.copy([],e.nodeMatrix),o.properties.geometryResource=e,n.isBloom()&&(o.bloom=1),o.transparent=n.yt();const u=e.extraInfo;return"BLEND"!==u.alphaMode&&"MASK"!==u.alphaMode||(o.transparent=!0),this.ht(o,n),o}ct(t,e,r){q[t.geometry.desc.primitive]<4?e.push(t):r.push(t)}k(t,e){let s=null;const n=t.getShader(),i=t.getUniforms()||{},o=e.materialInfo||{};if("phong"===n)if("pbrSpecularGlossiness"===o.name)s=new r.reshader.PhongSpecularGlossinessMaterial(o);else{for(const t in C)i[t]=i[t]||C[t];s=new r.reshader.PhongMaterial(o)}else if("wireframe"===n)s=new r.reshader.WireFrameMaterial(o);else if("pbr"===n){if(s="pbrSpecularGlossiness"===o.name?new r.reshader.pbr.StandardSpecularGlossinessMaterial(o):new r.reshader.pbr.StandardMaterial(o),this.regl&&!r.reshader.pbr.PBRUtils.isSupported(this.regl)){s=r.reshader.PhongMaterial.convertFrom(s);for(const t in C)i[t]=i[t]||C[t]}}else s=new r.reshader.Material(o);s.doubleSided=e.extraInfo&&e.extraInfo.doubleSided?1:0;for(const t in i)s.set(t,i[t]);return e.morphWeights&&this.bt(e.morphWeights,s),e.skin&&(s.set("jointTextureSize",[4,6]),s.set("numJoints",e.skin.numJoints),s.set("jointTexture",e.skin.jointTexture),s.set("skinAnimation",0)),s}bt(t,e){const r=e.get("morphWeights1")||[],s=e.get("morphWeights2")||[];for(let e=0;e<4;e++)r[e]=t[e]||0,s[e]=t[e+4]||0;e.set("morphWeights1",r),e.set("morphWeights2",s)}ht(t,e){const r=e.getSymbol();r&&r.uniforms?(t.setUniform("polygonFill",r.uniforms.polygonFill||L),t.setUniform("polygonOpacity",void 0===r.uniforms.polygonOpacity?1:r.uniforms.polygonOpacity),t.setUniform("lineColor",r.uniforms.lineColor||L),t.setUniform("lineOpacity",void 0===r.uniforms.lineOpacity?1:r.uniforms.lineOpacity)):(t.setUniform("polygonFill",L),t.setUniform("polygonOpacity",1),t.setUniform("lineColor",L),t.setUniform("lineOpacity",1))}_t(t){const e=this.layer.getMap();if(!this.gltfScenes[t])return null;const s=this.gltfScenes[t].modelMeshes,i=this.layer.u()[t],o=this.xt(s,i);if(!o)return null;const a=o.min,h=o.max,u=r.vec4.set(F,a[0],a[1],a[2],1),c=r.vec4.set(U,h[0],h[1],h[2],1),l=r.vec4.transformMat4(u,u,e.projViewMatrix),f=r.vec4.transformMat4(c,c,e.projViewMatrix),d=(l[0]/l[3]+1)*e.width/2,m=(1-l[1]/l[3])*e.height/2,p=(f[0]/l[3]+1)*e.width/2,g=(1-f[1]/l[3])*e.height/2,y=Math.min(d,p),b=Math.max(d,p),_=Math.min(m,g),x=Math.max(m,g);return new n.Extent({xmin:y,xmax:b,ymin:_,ymax:x})}L(){this.canvas&&r.reshader.pbr.PBRUtils.logoutIBLResOnCanvas(this.canvas,this.getMap())}U(t){const e=this.layer.getMap(),{iblTexes:s,dfgLUT:i}=r.reshader.pbr.PBRUtils.getIBLResOnCanvas(this.canvas);if(e&&e.getLights()){const o=r.reshader.pbr.PBRUtils.getPBRUniforms(e,s,i,t&&t.ssr,t&&t.jitter),a=e.getLights(),h=a.ambient&&a.ambient.color?a.ambient.color:[.2,.2,.2];this.T.ambientColor=h,o&&n.Util.extend(this.T,o)}else{const s=r.reshader.pbr.PBRUtils.getPBRUniforms(e,null,i,t&&t.ssr,t&&t.jitter);n.Util.extend(this.T,s)}}ot(t,e){"effectmarker"===e.getGLTFMarkerType()?e.updateUV(P):"glowmarker"===e.getGLTFMarkerType()&&e.vt();const r=e.getUniforms();if(r&&e.isDirty()&&e.wt())for(const e in r)t.material.set(e,r[e]);e.yt()&&(t.transparent=!0),t.bloom=+!!e.isBloom(),"wireframe"===e.getShader()&&r&&r.dashAnimate&&t.material.set("time",P/1e3)}at(t,e){if("pbr"===e.getShader()){const e=t.getDefines(),{iblTexes:s}=r.reshader.pbr.PBRUtils.getIBLResOnCanvas(this.layer.getRenderer().canvas);s?e.HAS_IBL_LIGHTING=1:delete e.HAS_IBL_LIGHTING,t.setDefines(e)}}Tt(t,e){const s=t.I(),n=[],i=t.getShader(),o=this.i.getGLTF(e);if(o&&o.resources){if(!o.resources.length){const e="there are no geomtries in the gltf model";return console.error(e),void this.layer.fire("modelerror",{type:"modelerror",marker:t,info:e})}t.gltfPack=o.gltfPack,o.resources.forEach((t=>{const e=this.lt(t,s,i);n.push(e)}))}else{const e=t.Ot();r.reshader.GLTFHelper.exportGLTFPack(e).getMeshesInfo().forEach((t=>{const e=this.lt(t,s,i);n.push(e)}))}this.gltfScenes[s]&&this.St(t,this.gltfScenes[s].modelMeshes),this.gltfScenes[s]={pickingId:s,modelMeshes:n},t.Mt()?t.Mt()&&(t.At([1,1,1]),t.It([0,0,0]),this.Et(t,n)):this.Et(t,n),this.rt(s,!0),this.setToRedraw(),t.fire("createscene-debug",{scene:this.gltfScenes[s]})}Pt(t,e){const r=t.getUrl();t.Nt(e.json),this.layer.kt[r]+=1,this.Tt(t,r),this.A(t),t.Ct(!0),t.fire("load",{data:e.json}),this.Lt()&&this.layer.fire("modelload",{models:this.layer.getGLTFUrls()}),t.fire("setUrl-debug"),this.V=!0}loginGLTF(t){const e=this.i;if(!e)return;const r=t.getUrl();if(A[r])return void this.Rt(t);const s=e.getGLTF(r);if(s)return this.i.loginGLTF(r,s),void this.Pt(t,s);this.workerConn.loadGLTF(r,((e,s)=>{if(e)return console.error(e),void this.layer.fire("modelerror",{type:"modelerror",marker:t,info:e});delete s.transferables,this.i.loginGLTF(r,s);const n=this.i.getGLTF(r);this.Pt(t,n)}))}logoutGLTF(t){const e=this.i;e&&!A[t]&&e.logoutGLTF(t)}p(){const t=this.layer._geoList;for(let e=0;e<t.length;e++)this.loginGLTF(t[e])}Lt(){if(!this.layer)return;const t=this.layer._geoList;for(let e=0;e<t.length;e++)if(!t[e].isLoaded())return!1;return!0}Rt(t){const e=function(t){let e=null;return A[t]&&(e={meshes:A[t].meshes},e.scenes=JSON.parse(JSON.stringify(A[t].scenes))),e}(t.getUrl());this.Pt(t,{json:e})}Et(t,e){this.rt(t.I(),!0);let r=this.xt(e,t);if(!r)return;const s=this.Bt(t.Mt()||[],t,r);if(t.At(s),this.rt(t.I(),!0),r=this.xt(e,t),!r)return;const n=this.Ft(t.Ut()||[],r,t);t.It(n),t.Dt=r}Bt(t,e,s){const n=r.vec3.subtract(t,s.max,s.min),i=Math.max(...n);let o=null;o=e.Mt()?e.Vt():e.jt();const a=function(t,e,r){return e*t.getGLScale(r)}(this.layer.getMap(),o,e.getZoomOnAdded()),h=a/i,u=r.vec3.set(t,h,h,h);return r.vec3.multiply(t,e.getScale(),u)}Ft(t,e,s){if("multigltfmarker"===s.getGLTFMarkerType())return r.vec3.set(t,0,0,-e.min[2]);if(!this.qt(s))return s.Ut();const n=s.getAnchorZ()||"bottom";let i=0;"bottom"===n?i=-e.min[2]:"top"===n?i=-e.max[2]:"center"===n&&(i=-(e.min[2]+e.max[2])/2);const o=s.getModelMatrix(),a=s.getTranslation();return r.vec3.set(t,-(e.min[0]+e.max[0])/2+o[12],-(e.min[1]+e.max[1])/2+o[13],i+a[2])}qt(t){const e=t.getUrl(),r=t.getSymbol(),s=r&&r.fixSizeOnZoom;if((!s||s<0)&&!t.st()&&t.et===e)return!1;const n=this.layer.getMap();return!(s>0&&!n.isZooming())}xt(t,e){if(!t||!t.length)return null;if(!this.qt(e))return e.Dt;"multigltfmarker"===e.getGLTFMarkerType()&&t.forEach((t=>{const r=e.gt();for(const e in r)t.updateInstancedData(e,r[e]);t.updateBoundingBox()})),this.rt(e.I(),!0);const s=t[0].getBoundingBox(),n=r.vec3.copy([],s[0]),i=r.vec3.copy([],s[1]);for(let e=1;e<t.length;e++){const s=t[e].getBoundingBox(),o=r.vec3.copy([],s[0]),a=r.vec3.copy([],s[1]);o[0]<n[0]&&(n[0]=o[0]),o[1]<n[1]&&(n[1]=o[1]),o[2]<n[2]&&(n[2]=o[2]),a[0]>i[0]&&(i[0]=a[0]),a[1]>i[1]&&(i[1]=a[1]),a[2]>i[2]&&(i[2]=a[2])}return{min:n,max:i}}rt(t,e){const s=this.gltfScenes[t];if(!s)return;const i=this.layer.u()[t];i.Gt();const o=i.isAnimated(),a=this.Jt(i),u=this.isInFrustum(i);if(o&&i.gltfPack&&a&&u&&!e){const t=i.zt();if(h(t)){const e=i.isAnimationLooped(),r=i.getAnimationSpeed();(e||!e&&i.gltfPack.isFirstLoop(P,r,t))&&i.gltfPack.updateAnimation(P,e,r,t)}else console.warn("animation specified does not exist!")}const c=s.modelMeshes,l=i.getModelMatrix();r.mat4.multiply(l,l,j);const f=this.layer.getMap(),d=[],m=[];c.forEach((t=>{V[0]=V[1]=V[2]=1;const e=i.getSymbol(),s=e&&e.fixSizeOnZoom;if(n.Util.isNumber(s))if(s>=0){let t=f.getGLScale()/f.getGLScale(s);t*=i.Xt(),r.vec3.set(V,t,t,t),i.Ht(t)}else{const t=i.Kt();r.vec3.set(V,t,t,t),i.$t(t)}const a=i.Mt()||[1,1,1];r.vec3.multiply(d,a,V);const h=o?t.properties.geometryResource.nodeMatrix:t.nodeMatrix;if(t instanceof r.reshader.InstancedMesh){r.mat4.scale(m,l,d);const e=r.mat4.multiply(t.positionMatrix,m,h);t.positionMatrix=e}else{r.mat4.scale(m,l,d);const e=r.mat4.multiply(t.localTransform,m,h);t.localTransform=e}if(o){t.material.set("skinAnimation",1);const e=t.geometry.properties.morphWeights;e&&this.bt(e,t.material)}else t.material.set("skinAnimation",0)})),e||this.Wt(i,c)}Wt(t,e){const s=this.xt(e,t);if(!s)return;const n=this.Ft(t.Ut()||[],s,t);e.forEach((e=>{e instanceof r.reshader.InstancedMesh?(e.positionMatrix[12]+=n[0],e.positionMatrix[13]+=n[1],e.positionMatrix[14]+=n[2],this.Yt(e,t)):(e.localTransform[12]+=n[0],e.localTransform[13]+=n[1],e.localTransform[14]+=n[2])}))}St(t,e){const s=this.xt(e,t);t.Dt=s;const n=r.vec3.subtract(B,s.max,s.min);r.vec3.divide(n,n,t.getScale());const i=Math.max(...n)/this.layer.getMap().getGLScale(t.getZoomOnAdded());t.Zt(i)}Qt(t,e){for(const r in e)t.setUniform(r,e[r]);return t}Yt(t,e){const r=e.gt();for(const e in r)t.updateInstancedData(e,r[e]);this.regl?t.generateInstancedBuffers(this.regl):(this._=this._||[],this._.push(t)),t.instanceCount=e.getCount()}te(t){if(h(t)){this.ee(t);const e=this.layer.u()[t].getUrl();this.logoutGLTF(e),delete this.gltfScenes[t],this.setToRedraw(),this.V=!0}}ee(t){if(!this.gltfScenes[t])return;this.gltfScenes[t].modelMeshes.forEach((t=>{t.dispose()}))}m(t,e){const r=["webgl","experimental-webgl"];let s=null;for(let n=0;n<r.length;++n){try{s=t.getContext(r[n],e)}catch(t){}if(s)break}return s}re(t,e,r={}){if(!this.O)return null;const s=this.layer.getMap(),i=this.canvas.gl&&this.canvas.gl.wrap;if(this.W||i){if(!this.l||0===this.l.length)return null;const t=this.tt(),e=n.Util.extend({},this.T);e.pointSize=this.layer.options.pointSize||1,this.O.render(t,e,!0),this.W=!1}const{meshId:o,pickingId:a,point:h}=this.O.pick(t,e,r.tolerance||3,{"projViewMatrix":s.projViewMatrix,"pointSize":this.layer.options.pointSize||1},{viewMatrix:s.viewMatrix,projMatrix:s.projMatrix,returnPoint:!0}),u=this.se(a);return{meshId:o,target:this.layer.u()[u],pickingId:a,point:h,index:a-u}}se(t){if(!h(t))return null;if(this.layer.u()[t])return t;const e=Object.keys(this.layer.u()).sort().map((t=>Number(t))),r=e.length;let s=0,n=r-1,i=Math.floor((s+n)/2);for(;s<=r-1&&n>=0;){if(s===n)return e[s];if(e[i]<=t&&t<e[i+1])return e[i];t<e[i]?(n=i-1,i=Math.floor((s+n)/2)):e[i+1]<t&&(s=i+1,i=Math.floor((s+n)/2))}return null}Jt(t){return"effectmarker"!==t.getGLTFMarkerType()&&"glowmarker"!==t.getGLTFMarkerType()}isInFrustum(t){const e=this.layer.getMap(),s=t.Dt;if(!s||"multigltfmarker"===t.getGLTFMarkerType())return!0;const n=r.vec2.set(k,s.min,s.max);return!!m(e.projViewMatrix,n)}getRenderMeshesTest(){return this.tt()}isMarkerTransparent(t){return t.yt()}getMarkerMeshes(t){const e=t.I();return this.gltfScenes[e].modelMeshes}getMarkerFitSizeScale(t){return t.Mt()}getMarkerFitTranslate(t){return t.Ut()}getFBORayPicking(){return this.O}getShaderList(){return this.o}}function z(t,e){var r,s,n;if(Z(t)){var i,o=t.stops&&"object"==typeof t.stops[0][0],a=o||void 0!==t.property,h=o||!a,u=t.type||e||"exponential";if("exponential"===u)i=K;else if("interval"===u)i=H;else if("categorical"===u)i=X;else{if("identity"!==u)throw new Error('Unknown function type "'+u+'"');i=$}if(o){var c={},l=[];for(let e=0;e<t.stops.length;e++){var f=t.stops[e];void 0===c[f[0].zoom]&&(c[f[0].zoom]={zoom:f[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),c[f[0].zoom].stops.push([f[0].value,f[1]])}for(let t in c)l.push([c[t].zoom,z(c[t])]);r=function(e,r){const s=K({stops:l,base:t.base},e)(e,r);return"function"==typeof s?s(e,r):s},s=!1,n=!1}else h?(r=function(e){const r=i(t,e);return"function"==typeof r?r(e):r},s=!0,n=!1):(r=function(e,r){const s=i(t,r?r[t.property]:null);return"function"==typeof s?s(e,r):s},s=!1,n=!0)}else r=function(){return t},s=!0,n=!0;return r.isZoomConstant=n,r.isFeatureConstant=s,r}function X(t,e){for(let r=0;r<t.stops.length;r++)if(e===t.stops[r][0])return t.stops[r][1];return t.default}function H(t,e){for(var r=0;r<t.stops.length&&!(e<t.stops[r][0]);r++);return t.stops[Math.max(r-1,0)][1]}function K(t,e){for(var r=void 0!==t.base?t.base:1,s=0;!(s>=t.stops.length||e<=t.stops[s][0]);)s++;return 0===s?t.stops[s][1]:s===t.stops.length?t.stops[s-1][1]:W(e,r,t.stops[s-1][0],t.stops[s][0],t.stops[s-1][1],t.stops[s][1])}function $(t,e){return r=e,s=t.default,void 0!==r?r:void 0!==s?s:void 0!==n?n:null;var r,s,n}function W(t,e,r,s,n,i){return"function"==typeof n?function(){var o=n.apply(void 0,arguments),a=i.apply(void 0,arguments);return W(t,e,r,s,o,a)}:n.length?function(t,e,r,s,n,i){var o=[];for(let a=0;a<n.length;a++)o[a]=Y(t,e,r,s,n[a],i[a]);return o}(t,e,r,s,n,i):Y(t,e,r,s,n,i)}function Y(t,e,r,s,n,i){var o,a=s-r,h=t-r;return n*(1-(o=1===e?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1)))+i*o}function Z(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function Q(t){for(const e in t)if(Z(t[e]))return!0;return!1}function tt(t){return rt(t,"exponential")}function et(t,e){if(!t)return null;var r=!1;if(Array.isArray(t)){var s,n=[];for(let i=0;i<t.length;i++)s=et(t[i],e),s?(n.push(s),r=!0):n.push(t[i]);return r?n:t}var i,o={"__fn_types_loaded":!0},a=[];for(i in t)t.hasOwnProperty(i)&&a.push(i);const h=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=tt(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let e=0,s=a.length;e<s;e++)i=a[e],Z(t[i])?(r=!0,o["_"+i]=t[i],h(i)):o[i]=t[i];return r?o:t}function rt(t,e){if(!Z(t))return function(){return t};let r=!0,s=!0;const n=(t=JSON.parse(JSON.stringify(t))).stops;if(n)for(let t=0;t<n.length;t++)if(Z(n[t][1])){const i=rt(n[t][1],e);r=r&&i.isZoomConstant,s=s&&i.isFeatureConstant,n[t]=[n[t][0],i]}const i=z(t,e);return i.isZoomConstant=r&&i.isZoomConstant,i.isFeatureConstant=s&&i.isFeatureConstant,i}const st=[];class nt extends e.Marker{constructor(t,s){const n=e.Util.extend({},s),i=n.symbol;super(t,n),this.options.symbol=i,this.ne=!1,this.ie=r.mat4.identity([]),this.oe="gltfmarker",this.ae=!0,this.he={get translation(){return[0,0,0]},get rotation(){return[0,0,0]},get scale(){return[1,1,1]}},this.Gt()}static parseJSONData(t){const e=nt.fromJSON(t);return e.setZoomOnAdded(t.zoomOnAdded),e}static fromJSON(t){return new nt(t.coordinates,t.options)}Ot(){return this.ue}Nt(t){this.ue=t}ce(t,e){this._externSymbol=this._externSymbol||{},this._externSymbol[t]=e,"uniforms"===t&&(this.le=!0)}setUrl(t){return super.updateSymbol({url:t}),this}setSymbol(t){const e=this.getUrl(),r=this.getShader(),s=this.fe&&this.fe.getRenderer();s&&t.url!==e&&s.logoutGLTF(e),super.setSymbol(t);(t.url||"pyramid")!==e&&this.fe&&(this.Ct(!1),this.fe.de(this),this.fe.A(this)),t.shader!==r&&this.fe&&this.fe.A(this),this.le=!0,this.ae=!0}getCenter(){const t=this.getMap();if(!t)return null;const r=c(t,super.getCenter()||this.getCoordinates()),s=this.getTranslation(),n=new e.Point([r[0]+s[0],r[1]+s[1]]);return t.pointAtResToCoord(n,t.getGLRes())}getUrl(){const t=this._getInternalSymbol();return t&&t.url||"pyramid"}addTo(t){if(this.fe)throw new Error("GLTFMarker cannot be added to two or more layers at the same time.");return t.addGeometry(this),this}onAdd(){const t=this.getLayer().getMap();if(t&&!h(this.me)){const e=t.getZoom();this.me=e}}remove(){this.fe&&(this.fe.pe(this),delete this.ue,delete this.gltfPack,super.remove())}show(){return super.updateSymbol({visible:!0}),this}hide(){super.updateSymbol({visible:!1})}setBloom(t){return super.updateSymbol({bloom:t}),this}isBloom(){const t=this._getInternalSymbol();return t&&t.bloom}setCastShadow(t){return super.updateSymbol({shadow:t}),this}isCastShadow(){const t=this._getInternalSymbol();return t&&t.shadow}outline(){return this.ge=!0,this.ae=!0,this}cancelOutline(){return this.ge=!1,this.ae=!0,this}isOutline(){return this.ge}isVisible(){const t=this._getInternalSymbol();return!t||!h(t.visible)||t.visible}setCoordinates(t){return super.setCoordinates(t),this.he&&this.Gt(),this.ae=!0,this.ye=!0,this}copy(){const t=this.toJSON(),e=nt.fromJSON(t);return e.setZoomOnAdded(this.me),e}setShader(t){return super.updateSymbol({shader:t}),this}getShader(){const t=this._getInternalSymbol();return t&&t.shader||"pbr"}setUniforms(t){return super.updateSymbol({uniforms:t}),this.le=!0,this}getUniforms(){const t=this._getInternalSymbol();return t&&t.uniforms}setUniform(t,e){const r=this.getUniforms()||{};return r[t]=e,super.updateSymbol({uniforms:r}),this.le=!0,this}getUniform(t){const e=this._getInternalSymbol();return e&&e.uniforms&&e.uniforms[t]}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation&&this.ue&&this.ue.animations}isDashAnimated(){const t=this._getInternalSymbol();return t&&t.uniforms&&t.uniforms.dashEnabled&&t.uniforms.dashAnimate}setAnimation(t){return super.updateSymbol({animation:t}),this}setAnimationLoop(t){return super.updateSymbol({loop:t}),this.ae=!0,this}isAnimationLooped(){const t=this._getInternalSymbol();return t&&t.loop}getAnimationSpeed(){const t=this._getInternalSymbol();return t&&h(t.speed)?t.speed:1}setAnimationSpeed(t){return super.updateSymbol({speed:t}),this}be(t){const e=this.getMap();return e?c(e,t||this.getCoordinates()):null}setTranslation(t){const e=t||this.he.translation;return super.updateSymbol({translation:e}),this.Gt(),this.ye=!0,this}getTranslation(){const t=this._getInternalSymbol();return t&&t.translation||this.he.translation}setTRS(t,e,r){const s=t||this.he.translation;return super.updateSymbol({translation:s,rotation:e,scale:r}),this.Gt(),this.ye=!0,this}_e(){const t=this.getTranslation(),e=this.be();return e?r.vec3.add(this.he.translation,t,e):t}setRotation(t){return super.updateSymbol({rotation:t}),this.Gt(),this.ye=!0,this}getRotation(){const t=this._getInternalSymbol();return t&&t.rotation||this.he.rotation}setScale(t){const e=t=t||this.he.scale;return super.updateSymbol({scale:e}),this.Gt(),this.ye=!0,this}getScale(){const t=this._getInternalSymbol();return t&&t.scale||this.he.scale}setFixSizeOnZoom(t){return super.updateSymbol({fixSizeOnZoom:t}),this}getFixSizeOnZoom(){const t=this._getInternalSymbol();return t&&t.fixSizeOnZoom}cancelFixSize(){return this.setFixSizeOnZoom(-1)}setAnchorZ(t){return super.updateSymbol({anchorZ:t}),this.ye=!0,this}getAnchorZ(){const t=this._getInternalSymbol();return t&&t.anchorZ||"bottom"}_setExternSymbol(t){return this.ae=!0,super._setExternSymbol(t)}xe(t){return et(t,(()=>{const t=this.getMap();if(t){return[t.getZoom()]}return null}))}_prepareSymbol(t){super._prepareSymbol(t);const e=this.xe(t);return e&&e.uniforms&&(e.uniforms=this.xe(t.uniforms)),delete this.ve,e}hasFunctionDefinition(){if(h(this.ve))return this.ve;const t=this._getInternalSymbol();return this.ve=Q(t)||t&&t.uniforms&&Q(t.uniforms),this.ve}onSymbolChanged(){super.onSymbolChanged(),this.he&&this.Gt()}setModelMatrix(t){const e=r.mat4.getTranslation(this.he.translation,t),s=r.mat4.getRotation(this.he.rotation,t),n=r.mat4.getScaling(this.he.scale,t);return this.setTranslation(e),this.setRotation(s),this.setScale(n),this}getModelMatrix(){return this.ie}Gt(){const t=this.getRotation(),e=3===t.length?r.quat.fromEuler(st,t[0]||0,t[1]||0,t[2]||0):t;this.ie=r.mat4.fromRotationTranslationScale(this.ie,e,this._e(),this.getScale())}isDirty(){return this.ae}setDirty(t){return this.ae=t,this}on(t,e,r){super.on(t,e,r||this),this.fe&&this.fe.we(t)}off(t,e,r){super.off(t,e,r||this),this.fe&&this.fe.Te()}Oe(){const t=this.toJSON();return t.zoomOnAdded=this.me,t}toJSON(){const t=JSON.parse(JSON.stringify({coordinates:this.getCoordinates(),options:this.options||{}})),r=this.getId();e.Util.isNil(r)||(t.options.id=r);const s=this.getProperties();s&&(t.options.properties=JSON.parse(JSON.stringify(s)));const n=this.getSymbol();return n&&(t.options.symbol=JSON.parse(JSON.stringify(n))),t}setZoomOnAdded(t){this.me=t}getZoomOnAdded(){return this.me}yt(){return this.q()<1}q(){const t=this.getUniforms(),e=this.getShader();return"phong"===e||"wireframe"===e?t&&h(t.opacity)?t.opacity:1:"pbr"===e&&t&&h(t.polygonOpacity)?t.polygonOpacity:1}Ct(t){this.ne=t}isLoaded(){return this.ne}getGLTFMarkerType(){return this.oe}Se(t){this.Me=t}I(){return this.Me}getCount(){return 1}At(t){this.Ae=t}Mt(){return this.Ae}It(t){this.Ie=t}Ut(){return this.Ie}getContainerExtent(){const t=this.getLayer();if(!t)throw Error("marker has not be added to layer");return t._t(this.Me)}getGLTFAsset(){return this.ue&&this.ue.asset}openInfoWindow(){this.ue?super.openInfoWindow():this.once("load",(()=>{super.openInfoWindow()}))}getAnimations(){if(!this.ue)return null;const t=this.ue.animations;return t?t.map(((t,e)=>t.name||e)):null}getCurrentAnimation(){const t=this._getInternalSymbol();return t&&t.animationName}zt(){const t=this.getAnimations();if(!t)return null;const e=this.getCurrentAnimation();return h(e)?t.indexOf(e)>-1?e:void 0:t[0]}setCurrentAnimation(t){this.updateSymbol({animationName:t})}Ht(t){this.Ee=t}Kt(){return this.Ee||1}$t(t){this.Pe=t}Xt(){return this.Pe||1}Zt(t){this.Ne=t}Vt(){return this.Ne}st(){return this.ye}nt(){this.ye=!1}wt(){return this.le}ut(){this.le=!1}setAnimationTimeframe(t){this.gltfPack.updateAnimation(t,this.isAnimationLooped(),this.getAnimationSpeed())}jt(){return this.options.fitSize||100}}nt.mergeOptions({symbol:null}),nt.registerJSONType("GLTFMarker");
/*!
       Feature Filter by

       (c) mapbox 2016 and maptalks 2018
       www.mapbox.com | www.maptalks.org
       License: MIT, header required.
   */
const it=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function ot(t){return new Function("f",`var p = (f && f.properties || {}); return ${at(t)}`)}function at(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";return`(${"=="===e?ut(t[1],t[2],"===",!1):"!="===e?ut(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?ut(t[1],t[2],e,!0):"any"===e?ct(t.slice(1),"||"):"all"===e?ct(t.slice(1),"&&"):"none"===e?dt(ct(t.slice(1),"||")):"in"===e?lt(t[1],t.slice(2)):"!in"===e?dt(lt(t[1],t.slice(2))):"has"===e?ft(t[1]):"!has"===e?dt(ft(t[1])):"true"})`}function ht(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function ut(t,e,r,s){const n=ht(t),i="$type"===t?it.indexOf(e):JSON.stringify(e);return(s?`typeof ${n}=== typeof ${i}&&`:"")+n+r+i}function ct(t,e){return t.map(at).join(e)}function lt(t,e){"$type"===t&&(e=e.map((t=>it.indexOf(t))));const r=JSON.stringify(e.sort(mt)),s=ht(t);return e.length<=200?`${r}.indexOf(${s}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${s}, ${r},0,${e.length-1})`}function ft(t){return"$id"===t?'"id" in f':`${JSON.stringify(t)} in p`}function dt(t){return`!(${t})`}function mt(t,e){return t<e?-1:t>e?1:0}function pt(t){if(!Array.isArray(t))return pt([t]);const e=[];for(let r=0;r<t.length;r++){let s;s=!0===t[r].filter?function(){return!0}:ot(t[r].filter),e.push(gt({},t[r],{filter:s}))}return e}function gt(t){for(let e=1;e<arguments.length;e++){const r=arguments[e];for(const e in r)t[e]=r[e]}return t}const yt=/\{ *([\w_]+) *\}/g;class bt extends nt{constructor(t,e){super(t,e),this.oe="effectmarker"}static fromJSON(t){return new bt(t.coordinates,t.options)}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}setTexture(t){const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const r=this.getTextureUrl();e.ke(r),e.Ce(t)}return super.updateSymbol({textureUrl:t}),this}Le(t){const e=this.getTextureUrl(),r=this.getLayer()&&this.getLayer().getRenderer();if(r){let s=e;const n=this.Re();if(n){const r=this.isAnimationLooped(),i=this.getAnimationSpeed()||1,o=r?Math.floor(.01*t*i)%n.length:Math.floor(.01*t);s=e.replace(yt,n[o]),this.setUniform("width",1),this.setUniform("height",1),this.setUniform("uvOffset",[0,0])}return r.Be(s,this.I())}return null}Re(){const t=this._getInternalSymbol();return t&&t.textureNames}getTextureUrl(){const t=this._getInternalSymbol();return t&&t.textureUrl||"default"}getUrl(){return"plane"}getShader(){return"effect"}setTransparent(t){return this.options.symbol.transparent=t,this}isTransparent(){return this.options.symbol.transparent}updateUV(t){const e=this.isAnimationLooped(),r=this.getAnimationSpeed()||1,s=this.getUniforms()||{},n=s.width||1,i=s.height||1;let o;const a=this.getEffectType();"uv"===a?o=e?.01*t*r%(n*i):.01*t:"sequence"===a&&(o=e?Math.floor(.01*t*r)%(n*i):Math.floor(.01*t));const h=Number(o%n),u=Math.floor(o/n),c=this.Le(t);this._getSymbol()?(this.setUniform("uvOffset",[h,u]),this.setUniform("width",n),this.setUniform("height",i),this.setUniform("texture",c)):this.ce("uniforms",{uvOffset:[h,u],width:n,height:i,texture:c})}_setExternSymbol(t){super._setExternSymbol(t);const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const t=this.getTextureUrl();e.Ce(t)}}getEffectType(){const t=this._getInternalSymbol();return t&&t.effect||"uv"}setEffectType(t){return this._getInternalSymbol().effect=t,this}remove(){const t=this.getLayer()&&this.getLayer().getRenderer();if(t){const e=this.getTextureUrl();t.ke(e)}super.remove()}}const _t=["Point","Polygon","LineString","MultiPoint","MultiPolygon","MultiLineString","GeometryCollection","Feature","FeatureCollection"].reduce(((t,e)=>(t[e]=!0,t)),{}),xt={toGeometry:function(t,r){if(e.Util.isString(t)&&(t=e.Util.parseJSON(t)),Array.isArray(t)){const s=[];for(let n=0,i=t.length;n<i;n++){const i=xt.Fe(t[n],r);Array.isArray(i)?e.Util.pushIn(s,i):s.push(i)}return s}return xt.Fe(t,r)},Fe:function(t,r){if(!t||e.Util.isNil(t.type))return null;const s=t.type;if("Feature"===s){const e=t.geometry,s=xt.Fe(e,r);return s?(s.setId(t.id),s.setProperties(t.properties),s):null}if("FeatureCollection"===s){const e=t.features;if(!e)return null;return xt.toGeometry(e,r)}if("Point"===s)return function(t,e){if("EffectLayer"===e)return new bt(t);return new nt(t)}(t.coordinates,r);if("GeometryCollection"===s){const e=t.geometries,s=[],n=e.length;for(let t=0;t<n;t++)s.push(xt.Fe(e[t],r));return s}throw new Error("geometry's type is invalid, only support type of Point")},isGeoJSON:function(t){return!(!t||"object"!=typeof t)&&(!!t.type&&(!!_t[t.type]&&!(t instanceof e.Geometry)))}};const vt=["mousedown","mouseup","mousemove","contextmenu","click","dbclick","touchstart","touchmove","touchend"],wt=/\{*(\$root)*\}/g;class Tt extends n.OverlayLayer{constructor(t,e,r){!e||e instanceof n.Geometry||Array.isArray(e)||_t[e.type]||(r=e,e=null),super(t,null,r),this.pickingId=0,this.Ue={},this.kt={},this.De={},this.mapEvents="";const s=r&&r.style;this.setStyle(s),e&&this.addGeometry(e)}static registerShader(t,e,r,s){b[t]={name:t,type:e,config:r,uniforms:s}}static removeShader(t){delete b[t]}static getShaders(){const t=[];for(const e in b)t.push({shader:e,uniforms:b[e].uniforms});return t}static getShaderMap(){return b}addGeometry(t,e){let r=xt.isGeoJSON(t)?xt.toGeometry(t,this.getJSONType()):t;r=Array.isArray(r)?r:[r];for(let t=0;t<r.length;t++)if(!this.Ve(r[t]))return void console.error("type of geometry is invalid");super.addGeometry(r,e),Array.isArray(r)&&this.addMarker(r)}addMarker(t){for(let e=0;e<t.length;e++){const r=t[e];r.Se(this.pickingId),this.Ue[this.pickingId]=r,r.fe=this,this.we(r.getListeningEvents());const s=r.getId();s&&(this.De[s]=r),r.fire("add",{type:"add",target:r,layer:this}),"multigltfmarker"===r.getGLTFMarkerType()?this.pickingId+=r.getCount():this.pickingId++,this.de(r)}}de(t){const e=this.getRenderer();e&&e.loginGLTF(t)}toJSON(t){t||(t={});const e={"type":this.getJSONType(),"id":this.getId(),"options":this.config()};if((a(t.style)||t.style)&&(e.style=this.getStyle()),a(t.geometries)||t.geometries){const t=[],r=this._geoList;for(let e=0;e<r.length;e++){const s=r[e].Oe();t.push(s)}e.geometries=t}return e}Ve(t){if(!t.getGLTFMarkerType)return!1;return this.options.marekrTypes.indexOf(t.getGLTFMarkerType())>-1}setStyle(t){return t?(this.options.style=t,this.je=JSON.parse(JSON.stringify(t)),this.qe(),this.fire("setstyle",{target:this,style:this.je}),this):(delete this.je,delete this.options.style,this)}getStyle(){return this.options.style}updateSymbol(t,e){const r=this.getStyle();this.Ge(t,e,r),this.Ge(t,e,this.je),this.qe(),this.fire("updatesymbol",{target:this,index:t,symbol:e})}Ge(t,e,r){if(!r)return;const s=(r.style?r.style:r)[t].symbol||{};for(const t in e)s[t]=e[t]}qe(){this.Je(this.je);const t=this.je.style?this.je.style:this.je;this.ze=pt(t);this._geoList.forEach((function(t){this.Xe(t)}),this)}getGLTFUrls(){return Object.keys(this.kt)}we(t){const e=n.Util.isString(t)?t.split(/\s+/).map((t=>"mouseleave"===t||"mouseenter"===t||"mouseout"===t?"mousemove":t)):t;let r=this.mapEvents;const s=u(e,vt).filter((t=>this.mapEvents.indexOf(t)<0));this.mapEvents+=" "+s.join(" "),this.mapEvents=this.mapEvents.trim();const i=this.mapEvents.replace(" "," dom:");r=r.replace(" "," dom:");const o=this.getMap();o&&(o.off("dom:"+r,this.He,this),o.on("dom:"+i,this.He,this))}Te(){const t={};let e=this.mapEvents;const r=this._geoList;for(let e=0;e<r.length;e++){const s=r[e].getListeningEvents().map((t=>"mouseleave"===t||"mouseenter"===t||"mouseout"===t?"mousemove":t));for(let e=0;e<s.length;e++)t[s[e]]=1}this.mapEvents=u(Object.keys(t),vt).join(" ");const s=this.mapEvents.replace(" "," dom:");e=e.replace(" "," dom:");const n=this.getMap();n&&(n.off("dom:"+e,this.He,this),n.on("dom:"+s,this.He,this))}Je(t){n.Util.isString(t.$root)&&t.style.forEach((e=>{const r=e.symbol.url;r&&r.indexOf("{$root}")>-1&&(e.symbol.url=r.replace(wt,t.$root))}))}Xe(t){if(!this.ze)return!1;for(let e=0,r=this.ze.length;e<r;e++)if(!0===this.ze[e].filter({properties:t.getProperties()})){const r=this.ze[e].symbol,s=r.url;return t.ce("url",s),t.updateSymbol(r),!0}return!1}Ke(t){if(this.ze)for(let e=0,r=this.ze.length;e<r;e++)!0===this.ze[e].filter({properties:t.getProperties()})&&this.ze[e].outline&&t.outline()}removeGeometry(t){this.Te(),super.removeGeometry(t)}getMapEvents(){return this.mapEvents}pe(t){const e=n.Util.isString(t)?this.De[t].I():t.I(),r=this.getRenderer();r&&r.te(e),delete this.Ue[e],delete this.De[t]}clear(){return super.clear(),this.Ue={},this.De={},this}u(){return this.Ue}re(t,e,r){const s=this.getRenderer();return s?s.re(t,e,r):null}_t(t){const e=this.getRenderer();return e?e._t(t):null}He(t){if(!this.options.markerEvents)return;const e=this.getMap();if(!e)return;this.$e=this.We,this.Ye=this.Ze,this.Qe=this.tr,this.er=this.rr;const r=t.containerPoint,s=Math.round(r.x),n=Math.round(r.y);if(s<=0||s>=e.width||n<=0||n>=e.height)return this.We=null,this.tr=null,void(this.Ze=null);const i=this.re(s,n);if(!i)return;i.coordinate=t.coordinate,this.We=i.target?i.target.I():null,this.tr=i.meshId,this.Ze=JSON.stringify(i.point),this.rr=i.pickingId;const o=t.type.replace("dom:","");if("mousemove"===o){this.sr().forEach((t=>{t.target.fire(t.type,t)}))}else i.target&&i.target.fire(o,i)}sr(){const t=[];return h(this.We)&&!h(this.$e)?t.push({type:"mouseenter",target:this.Ue[this.We],meshId:this.tr,pickingId:this.rr,point:JSON.parse(this.Ze)}):!h(this.We)&&h(this.$e)?t.push({type:"mouseout",target:this.Ue[this.$e],meshId:this.Qe,pickingId:this.er,point:JSON.parse(this.Ye)},{type:"mouseleave",target:this.Ue[this.$e],meshId:this.Qe,pickingId:this.er,point:JSON.parse(this.Ye)}):h(this.We)&&h(this.$e)&&(this.We===this.$e?t.push({type:"mousemove",target:this.Ue[this.We],meshId:this.tr,pickingId:this.rr,point:JSON.parse(this.Ze)}):t.push({type:"mouseenter",target:this.Ue[this.We],meshId:this.tr,pickingId:this.rr,point:JSON.parse(this.Ze)},{type:"mouseout",target:this.Ue[this.$e],meshId:this.Qe,pickingId:this.er,point:JSON.parse(this.Ye)},{type:"mouseleave",target:this.Ue[this.$e],meshId:this.Qe,pickingId:this.er,point:JSON.parse(this.Ye)})),t}A(t){const e=this.getRenderer();e&&e.A(t)}outlineBatch(t){const e=this.je.style?this.je.style:this.je;e[t].outline=!0,this.ze=pt(e);this._geoList.forEach((t=>{this.Ke(t)}))}outlineAll(){this._geoList.forEach((t=>{t.outline()}))}cancelOutline(){if(this.je){(this.je.style?this.je.style:this.je).forEach((t=>{delete t.outline}))}this._geoList.forEach((t=>{t.cancelOutline()}))}}Tt.mergeOptions({"renderer":"gl","doubleBuffer":!1,"glOptions":null,"markerEvents":!0,"forceRenderOnZooming":!0,"forceRenderOnMoving":!0,"forceRenderOnRotating":!0});class Ot extends Tt{static initDefaultShader(){const t=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new r.reshader.PhongMaterial;return{shader:t,material:e}}();Ot.registerShader("phong","PhongShader",t.shader,t.material.getUniforms());const e=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{cull:{enable:!1,face:"back"},frontFace:"cw",blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new r.reshader.WireFrameMaterial;return{shader:t,material:e}}();Ot.registerShader("wireframe","WireframeShader",e.shader,e.material.getUniforms());const s=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",tangentAttribute:"TANGENT",colorAttribute:"COLOR_0",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",extraCommandProps:{cull:{enable:!0},frontFace:"ccw",blend:{enable:(t,e)=>!!e.meshConfig.transparent,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},e=new r.reshader.pbr.StandardMaterial({});return{shader:t,material:e}}();Ot.registerShader("pbr","pbr.StandardShader",s.shader,s.material.getUniforms()),Ot.registerShader("depth","pbr.StandardDepthShader",s.shader,s.material.getUniforms());const n=function(){const t={positionAttribute:"POSITION",color0Attribute:"COLOR_0",extraCommandProps:{blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new r.reshader.Material;return{shader:t,material:e}}();Ot.registerShader("pointline","PointLineShader",n.shader,n.material.getUniforms())}static fromJSON(t){if(!t||"GLTFLayer"!==t.type)return null;const e=new Ot(t.id,t.options),r=t.geometries,s=[];for(let t=0;t<r.length;t++){const e=nt.parseJSONData(r[t]);e&&s.push(e)}return e.addGeometry(s),t.style&&e.setStyle(t.style),e}onAdd(){const t=this.getMap();t.on(this.mapEvents,this.He,this);this._geoList.forEach((e=>{h(e.getZoomOnAdded())||e.setZoomOnAdded(t.getZoom())})),super.onAdd()}onRemove(){super.onRemove(),this.clear()}remove(){const t=this.getMap();if(!t)return;const e=this.mapEvents.replace(" "," dom:");t.off("dom:"+e,this.He,this),super.remove()}identify(t,e){const r=this.getMap();if(!r)return[];const s=r.coordinateToContainerPoint(new n.Coordinate(t));return this.identifyAtPoint(s,e)}identifyAtPoint(t,e){const r=this.getMap();if(!r)return[];const s=r.getDevicePixelRatio(),n=t.x*s,i=t.y*s,o=this.re(n,i,e);return o&&o.target?[{data:o.target,point:o.point}]:[]}nr(){const t=this.getRenderer();t?this.ir(t.gltfScenes):this.on("renderercreate",(t=>{this.ir(t.renderer.gltfScenes)}))}ir(t){this.pickingId=0;for(const e in this.Ue){const r=this.Ue[e],s=t[e],n=r.I();delete this.Ue[n],delete t[n],r.Se(this.pickingId),this.Ue[this.pickingId]=r,t[this.pickingId]=s;const i=r.getCount();this.pickingId+=i}}}Ot.initDefaultShader(),Ot.mergeOptions({marekrTypes:["gltfmarker","multigltfmarker"],pointSize:1}),Ot.registerJSONType("GLTFLayer"),Ot.registerRenderer("gl",J);const St=[1,1,1,1],Mt=[],At=[];class It extends nt{constructor(t,e){super(null,e),this.ar=t,this.hr=[],this.oe="multigltfmarker"}static fromJSON(t){return new It(t.data,t.options)}setCoordinates(t){return Array.isArray(t[0])?this.ur=t.map((t=>new e.Coordinate(t))):this.ur=t,this.updateAllData("coordinates",this.ur),this.ae=!0,this}getCoordinates(t){if(t&&this.ar&&this.ar.length){const e=t.index;return this.ar[e].coordinates}return null}addData(t){this.ar.push(t);const e=this.getLayer();return e&&e.nr(),this.ae=!0,this}removeData(t){return this.ar.splice(t,1),this.dt&&this.hr.splice(t,1),this.ae=!0,this}getData(t){return this.ar[t]}updateData(t,e,r){return this.ar[t][e]=r,this.ae=!0,this}updateAllData(t,e){for(let r=0;r<this.ar.length;r++)this.updateData(r,t,e[r]);return this}dt(){if(this.ar){this.hr=this.hr||[];for(let t=0;t<this.ar.length;t++){const e=this.cr(t);this.hr[t]=e}}}cr(t){const e=this.ar[t],s=this.be(e.coordinates),n=r.vec3.add(Mt,e.translation||this.he.translation,s||this.he.translation),i=e.rotation||this.he.rotation,o=e.scale||this.he.scale,a=r.quat.fromEuler(At,i[0]||0,i[1]||0,i[2]||0);return r.mat4.fromRotationTranslationScale(this.hr[t]||[],a,n,o)}Gt(){super.Gt(),this.dt()}lr(){this.dr&&this.dr.instance_vectorA.length/4===this.hr.length||(this.dr={"instance_vectorA":[],"instance_vectorB":[],"instance_vectorC":[],"instance_color":[],"aPickingId":[]});for(let t=0;t<this.hr.length;t++){const e=this.hr[t];this.mr("instance_vectorA",t,e,0),this.mr("instance_vectorB",t,e,1),this.mr("instance_vectorC",t,e,2);const r=this.ar[t].color||St;this.dr.instance_color[4*t]=r[0],this.dr.instance_color[4*t+1]=r[1],this.dr.instance_color[4*t+2]=r[2],this.dr.instance_color[4*t+3]=r[3],this.dr.aPickingId[t]=this.I()+t}return this.dr}mr(t,e,r,s){this.dr[t][4*e]=r[s],this.dr[t][4*e+1]=r[s+4],this.dr[t][4*e+2]=r[s+8],this.dr[t][4*e+3]=r[s+12]}gt(t){return this.ae?this.lr(t):this.dr}getCount(){return this.ar.length}toJSON(){const t=JSON.parse(JSON.stringify({data:this.ar,options:this.options})),e=this.getProperties();return t.options&&(t.options.properties=e),t}getIndexByPickingId(t){return t-this.I()}}const Et=new r.reshader.Texture2D({url:void 0,mag:"linear"});class Pt extends J{constructor(t){super(t),this._textureMap={}}Be(t){return this.regl&&this._textureMap[t]?this._textureMap[t].texture.getREGLTexture(this.regl):Et}Ce(t){if(this._textureMap[t])this._textureMap[t].count++;else{this.pr=this.pr||new r.reshader.ResourceLoader;const e="default"===t?void 0:t,s=new r.reshader.Texture2D({url:e,mag:"linear"},this.pr);s.once("complete",(()=>{this.setToRedraw()}),this),this._textureMap[t]={count:1,texture:s}}}ke(t){this._textureMap[t]&&(this._textureMap[t].count--,this._textureMap[t].count<1&&(this._textureMap[t].texture.dispose(),delete this._textureMap[t]))}}class Nt extends Tt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new r.reshader.Material;return{shader:t,material:e}}();Nt.registerShader("effect","MeshShader",t.shader,t.material.getUniforms())}onAddGeometry(t){super.onAddGeometry(t);const e=t.getTextureUrl(),r=this.getRenderer();r?r.Ce(e):this.on("renderercreate",(t=>{t.renderer.Ce(e)}))}remove(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const r=e.getTextureUrl();t.ke(r)})),super.remove()}clear(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const r=e.getTextureUrl();t.ke(r)})),super.clear()}getTextureMapTest(){const t=this.getRenderer();return t?t._textureMap:null}}Nt.initDefaultShader(),Nt.mergeOptions({marekrTypes:["effectmarker"]}),Nt.registerJSONType("EffectLayer"),Nt.registerRenderer("gl",Pt);class kt extends nt{constructor(t,e){super(t,e),this.oe="glowmarker"}static fromJSON(t){return new kt(t.coordinates,t.options)}getUrl(){return"plane"}setSpeed(t){this.setUniform("speed",t)}getSpeed(){return this._getInternalSymbol().uniforms.speed}getShader(){return"glowmarker"}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}vt(){let t=this._getInternalSymbol().uniforms.time||0;t+=.01,this.setUniform("time",t)}}kt.mergeOptions({visible:!0});class Ct extends Tt{static initDefaultShader(){const t=function(){const t={vert:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        attribute vec3 aPosition;\n        uniform mat4 projViewModelMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 positionMatrix;\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        #include <get_output>\n        void main(){\n            mat4 localPositionMatrix = getPositionMatrix();\n            vec4 localVertex = getPosition(aPosition);\n            vec4 position = localPositionMatrix * localVertex;\n            gl_Position = projViewModelMatrix * position;\n            vec4 worldPos = modelMatrix * position;\n            v_FragPos = worldPos.xyz;\n            v_center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n        }\n    ",frag:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        #define pi 3.14159\n        const float dotsnb = 30.0; // Number of dots\n\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        uniform float time;\n        uniform float radius;\n        uniform vec3 color;\n        uniform float speed;\n        vec3 hsb2rgb(in vec3 c)\n        {\n            vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,0.0,1.0 );\n            rgb = rgb*rgb*(4.0-2.0*rgb);\n            return c.z * mix( vec3(1.0), rgb, c.y);\n        }\n\n        void main()\n        {\n            float r = length(v_FragPos - v_center);\n            r = r*2.-1.;\n            if(r>radius) {\n                gl_FragColor = vec4(1.0,1.0,1.0, 0.0);\n            } else {\n                //vec3 color = hsb2rgb(vec3(fract(time*.1),.7,.4));\n                vec3 color = color;\n                float s = abs(sin(pow(r+5.0, 1.5)-time*speed+sin(r*0.9))*sin(r+.99));\n                color *= (abs(1./(s*10.8))-.01);\n                gl_FragColor = vec4(color, (color.x + color.y + color.z) / 1.0);\n            }\n        }\n    ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r.mat4.multiply([],e.projViewMatrix,e.modelMatrix)}}],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]}}},e=new r.reshader.Material;return{shader:t,material:e}}();Ct.registerShader("glowmarker","MeshShader",t.shader,t.material.getUniforms())}}Ct.initDefaultShader(),Ct.mergeOptions({marekrTypes:["glowmarker"]}),Ct.registerJSONType("GlowMarkerLayer"),Ct.registerRenderer("gl",J);const Lt={url:"plane",animation:!0,loop:!0,rotation:[0,0,0],translation:[0,0,30],scale:[1,1,30]},Rt={width:1,height:1,modelHeight:60,startOpacity:0,endOpacity:1};class Bt extends Tt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        varying float vHeight;\n        void main()\n        {\n            vec4 worldPosition = modelMatrix * vec4(aPosition, 1.0);\n            gl_Position = projViewMatrix * worldPosition;\n            vHeight = worldPosition.z;\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n        uniform float modelHeight;\n        uniform float startOpacity;\n        uniform float endOpacity;\n        varying float vHeight;\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            float opacity = (endOpacity - startOpacity) * (1.0 - vHeight / modelHeight);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a * opacity;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new r.reshader.Material;return{shader:t,material:e}}();Bt.registerShader("effectline","MeshShader",t.shader)}}Bt.initDefaultShader(),Bt.mergeOptions({marekrTypes:["effectmarker"]}),Bt.registerJSONType("EffectLineLayer"),Bt.registerRenderer("gl",Pt);const Ft={offsetX:0,offsetY:0,uReflectivity:.8,opacity:.9,color:[.9,0,0,1]};class Ut extends Tt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        attribute vec3 aNormal;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 normalMatrix;\n        uniform float offsetX;\n        uniform float offsetY;\n        varying vec2 uv;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            uv = vec2(aTexCoord.x + offsetX, aTexCoord.y + offsetY);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D effectTexture;\n        uniform vec3 uCameraPosition;\n        uniform mat4 viewMatrix;\n        uniform float uReflectivity;\n        uniform vec4 color;\n        uniform float opacity;\n\n        varying vec2 uv;\n\n        vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n            return normalize((vec4(dir, 0.0) * matrix).xyz);\n        }\n\n        const float GAMMA_FACTOR = 2.0;\n        vec4 GammaToLinear(in vec4 value, in float gammaFactor) {\n            return vec4(pow(value.xyz, vec3(gammaFactor)), value.w);\n        }\n\n        vec4 mixTexelToLinear(vec4 value) {\n            return GammaToLinear(value, float(GAMMA_FACTOR));\n        }\n\n        void main() {\n            vec4 texColor = texture2D(effectTexture, uv);\n            if (color.a == 0.0) {\n                discard;\n            }\n            vec4 mixColor = mixTexelToLinear(color);\n            texColor.rgb += mixColor.xyz * uReflectivity;\n            texColor.a*= opacity;\n            gl_FragColor = texColor;\n        }\n    ",uniforms:[{name:"normalMatrix",type:"function",fn:function(t,e){const s=[];return r.mat4.invert(s,e.modelMatrix),r.mat4.transpose(s,s),s}}],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new r.reshader.Material;return{shader:t,material:e}}();Ut.registerShader("effectring","MeshShader",t.shader)}}Ut.initDefaultShader(),Ut.mergeOptions({marekrTypes:["effectring"]}),Ut.registerJSONType("EffectRingLayer"),Ut.registerRenderer("gl",J);const Dt={animation:!0,loop:!0,url:"plane",effect:"sequence",speed:1,scale:[1,1,1],rotation:[90,0,0]},Vt={width:9,height:5};if(i.transcoders){const t=n.Map.VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){const t=i.transcoders.inject(o);n.registerWorkerAdapter("@maptalks/gltf-layer",t)}else n.registerWorkerAdapter("@maptalks/gltf-layer",(function(){return i.transcoders.inject(o)}))}else n.registerWorkerAdapter("@maptalks/gltf-layer",o);t.AEMarker=class extends bt{constructor(t,r){super(t,r);const s=e.Util.extend({},Dt,this.options.symbol);this.setSymbol(s);const n=e.Util.extend({},Vt,this.options.symbol.uniforms);this.setUniforms(n)}},t.EffectLayer=Nt,t.EffectLine=class extends bt{constructor(t,r){super(t,r);const s=e.Util.extend({},Lt,this.options.symbol);this.setSymbol(s);const n=e.Util.extend({},Rt,this.options.symbol.uniforms);this.setUniforms(n),this.setShader("effectline"),this.oe="effectmarker"}getEffectType(){return"sequence"}setTexture(t){return this.setUniform("texture",t),this}setHeight(t){return this.setUniform("modelHeight",t),this}setStartOpacity(t){return this.setUniform("startOpacity",t),this}setEndOpacity(t){return this.setUniform("endOpacity",t),this}},t.EffectLineLayer=Bt,t.EffectMarker=bt,t.EffectRing=class extends nt{constructor(t,r){super(t,r);const s=e.Util.extend({},Ft,this.options.symbol.uniforms);this.setUniforms(s),this.setShader("effectring"),this.oe="effectring"}},t.EffectRingLayer=Ut,t.GLTFLayer=Ot,t.GLTFMarker=nt,t.GlowMarker=kt,t.GlowMarkerLayer=Ct,t.MultiGLTFMarker=It,Object.defineProperty(t,"t",{value:!0}),"undefined"!=typeof console&&console.log("@maptalks/gltf-layer v0.33.4")}));
